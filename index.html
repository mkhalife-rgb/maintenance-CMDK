<!DOCTYPE html>  
<html lang="fr">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>Maintenance CMDK</title>  
    <style>  
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f8f9fa; display: flex; flex-direction: column; min-height: 100vh; }  
        header { background-color: #fd7e14; color: white; padding: 10px; text-align: center; position: relative; }  
        #section-select { position: absolute; top: 10px; right: 10px; padding: 5px; font-size: 14px; background-color: #fd7e14; color: white; border: none; border-radius: 5px; cursor: pointer; width: auto; }  
        nav { background-color: #e9ecef; padding: 10px; display: flex; justify-content: center; flex-wrap: wrap; align-items: center; }  
        nav button { margin: 5px; padding: 10px 15px; background-color: #fd7e14; color: white; border: none; border-radius: 5px; cursor: pointer; }  
        nav button:hover { background-color: #e06c0e; }  
        main { flex: 1; padding: 20px; max-width: 100%; overflow-x: auto; }  
        .tab-content { display: none; }  
        .tab-content.active { display: block; }  
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }  
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }  
        th { background-color: #fd7e14; color: white; }  
        form { margin-bottom: 20px; }  
        input, select { width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box; }  
        button { padding: 10px; background-color: #fd7e14; color: white; border: none; border-radius: 5px; cursor: pointer; }  
        button:hover { background-color: #e06c0e; }  
        #error-message { color: red; }  
        #tasksChart { max-width: 400px; margin: 20px auto; }  
        .no-data { text-align: center; color: #666; padding: 10px; }  
        @media (max-width: 600px) { nav { flex-direction: column; } }  
    </style>  
    <!-- Firebase SDK -->  
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>  
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>  
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>  
    <!-- Chart.js -->  
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>  
</head>  
<body>  
    <header>  
        <h1>Maintenance CMDK</h1>  
        <h2>Suivi des tâches</h2>  
        <select id="section-select" onchange="changeSection(this.value)" disabled>  
            <option value="maintenance">Maintenance</option>  
            <option value="it">IT</option>  
            <option value="biomed">Biomed</option>  
            <option value="logout">Déconnexion</option>  
        </select>  
    </header>  
    
    <nav id="nav-bar"></nav>  
    
    <main id="main-content"></main>  
    
    <script>  
        const firebaseConfig = {  
            apiKey: "AIzaSyBoQtCgGc2l7Myvig91dJ_rP9Bn0wZxgLU",  
            authDomain: "maintenance-cmdk-6613a.firebaseapp.com",  
            databaseURL: "https://maintenance-cmdk-6613a-default-rtdb.europe-west1.firebasedatabase.app",  
            projectId: "maintenance-cmdk-6613a",  
            storageBucket: "maintenance-cmdk-6613a.firebasestorage.app",  
            messagingSenderId: "113245925666",  
            appId: "1:113245925666:web:be055abeb157e90e74357b",  
            measurementId: "G-R5GYPC5SMZ"  
        };  

        firebase.initializeApp(firebaseConfig);  
        const db = firebase.database();  
        const auth = firebase.auth();  

        const adminEmail = "mkhalife@cmd.cd";  
        let currentUser = null;  
        let currentSection = 'maintenance';  
        let tasksChart = null;  
        const maintenanceSites = ['CMDG', 'CMDN', 'CMDLT', 'CMDB', 'Manhattan', 'Residence'];  

        auth.onAuthStateChanged(user => {  
            currentUser = user;  
            if (user) {  
                document.getElementById('section-select').disabled = false;  
                loadInterface();  
            } else {  
                loadLogin();  
            }  
        });  

        function changeSection(value) {  
            if (value === 'logout') {  
                logout();  
                return;  
            }  
            currentSection = value;  
            loadButtonsForSection();  
            openTab('dashboard');  
            chargerTousDonnees();  
        }  

        function loadLogin() {  
            const main = document.getElementById('main-content');  
            main.innerHTML = `  
                <div id="login" class="tab-content active">  
                    <h2>Connexion</h2>  
                    <form id="form-login">  
                        <input type="email" id="email" placeholder="Email" required>  
                        <input type="password" id="password" placeholder="Mot de passe" required>  
                        <button type="button" onclick="login()">Se connecter</button>  
                        <button type="button" onclick="register()">S'inscrire</button>  
                    </form>  
                    <p id="login-message"></p>  
                    <p id="error-message"></p>  
                </div>  
            `;  
            document.getElementById('nav-bar').innerHTML = '';  
            document.getElementById('section-select').disabled = true;  
            document.getElementById('section-select').value = 'maintenance';  
        }  

        function login() {  
            const email = document.getElementById('email').value;  
            const password = document.getElementById('password').value;  
            auth.signInWithEmailAndPassword(email, password)  
                .then(() => {  
                    document.getElementById('login-message').textContent = 'Connecté !';  
                    loadInterface();  
                })  
                .catch(err => {  
                    document.getElementById('error-message').textContent = 'Erreur: ' + err.message;  
                    console.error('Erreur de connexion:', err); // Pour debug  
                });  
        }  

        function register() {  
            const email = document.getElementById('email').value;  
            const password = document.getElementById('password').value;  
            auth.createUserWithEmailAndPassword(email, password)  
                .then(() => document.getElementById('login-message').textContent = 'Inscrit ! Connecte-toi.')  
                .catch(err => {  
                    document.getElementById('error-message').textContent = 'Erreur: ' + err.message;  
                    console.error('Erreur d\'inscription:', err); // Pour debug  
                });  
        }  

        function logout() {  
            auth.signOut().then(() => loadLogin());  
        }  

        function loadInterface() {  
            const main = document.getElementById('main-content');  
            main.innerHTML = '';  
            // Tabs communs  
            main.innerHTML += `  
                <div id="dashboard" class="tab-content">  
                    <h2>Tableau de Bord</h2>  
                    <div class="stats">  
                        <div class="stat" id="en-cours">Tâches en Cours : 0</div>  
                        <div class="stat" id="terminees">Tâches Terminées : 0</div>  
                        <div class="stat" id="en-attente">Tâches en Attente : 0</div>  
                    </div>  
                    <canvas id="tasksChart"></canvas>  
                </div>  
                <div id="userManagement" class="tab-content">  
                    <h2>Gestion des Utilisateurs</h2>  
                    <form id="form-userManagement">  
                        <input type="email" id="newUserEmail" placeholder="Entrez l'email de l'utilisateur" required>  
                        <button type="button" onclick="ajouterUtilisateur()">Ajouter Utilisateur</button>  
                    </form>  
                    <table id="table-users">  
                        <thead><tr><th>Email</th><th>Actions</th></tr></thead>  
                        <tbody></tbody>  
                    </table>  
                </div>  
                <div id="reports" class="tab-content">  
                    <h2>Rapports</h2>  
                    <button onclick="generateReports()">Générer Rapports</button>  
                    <h3>Rapport Mensuel</h3>  
                    <pre id="monthly-report"></pre>  
                    <h3>Rapport Annuel</h3>  
                    <pre id="annual-report"></pre>  
                </div>  
                <div id="completed-tasks" class="tab-content">  
                    <h2>Tâches Terminées</h2>  
                    <table id="table-completed">  
                        <thead><tr><th>Tâche</th><th>Date</th></tr></thead>  
                        <tbody></tbody>  
                    </table>  
                    <button type="button" onclick="effacerToutesDonneesTerminees()">Effacer Toutes les Tâches Terminées</button>  
                </div>  
            `;  
            // Tabs spécifiques  
            if (currentSection !== 'maintenance') {  
                main.innerHTML += `  
                    <div id="tasks" class="tab-content">  
                        <h2>Tâches à Suivre</h2>  
                        <form id="form-tasks">  
                            <input type="text" id="tache-tasks" placeholder="Description de la tâche" required>  
                            <select id="statut-tasks" required>  
                                <option value="">Statut</option>  
                                <option value="En cours">En cours</option>  
                                <option value="Terminée">Terminée</option>  
                                <option value="En attente">En attente</option>  
                            </select>  
                            <input type="date" id="date-tasks" required>  
                            <button type="button" onclick="ajouterTache('tasks')">Ajouter Tâche</button>  
                        </form>  
                        <table id="table-tasks">  
                            <thead><tr><th>Tâche</th><th>Statut</th><th>Date</th><th>Actions</th></tr></thead>  
                            <tbody></tbody>  
                        </table>  
                        <button onclick="exporterDonnees('tasks')">Exporter en CSV</button>  
                    </div>  
                `;  
            } else {  
                maintenanceSites.forEach(site => {  
                    main.innerHTML += `  
                        <div id="${site}" class="tab-content">  
                            <h2>${site} - Suivi des Tâches</h2>  
                            <form id="form-${site}">  
                                <input type="text" id="tache-${site}" placeholder="Description de la tâche" required>  
                                <select id="statut-${site}"

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance CMDK</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; display: flex; flex-direction: column; min-height: 100vh; }
        header { background-color: #007bff; color: white; padding: 10px; text-align: center; }
        nav { background-color: #e9ecef; padding: 10px; display: flex; justify-content: center; flex-wrap: wrap; align-items: center; }
        nav button { margin: 5px; padding: 10px 15px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; }
        nav button:hover { background-color: #218838; }
        nav select { margin: 5px; padding: 10px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        main { flex: 1; padding: 20px; max-width: 100%; overflow-x: auto; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #007bff; color: white; }
        form { margin-bottom: 20px; }
        input, select { width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box; }
        button { padding: 10px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        footer { background-color: #007bff; color: white; text-align: center; padding: 10px; }
        #error-message { color: red; }
        #tasksChart { max-width: 400px; margin: 20px auto; }
        @media (max-width: 600px) { nav { flex-direction: column; } }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header>
        <h1>Maintenance CMDK</h1>
        <h2>Suivi des tâches</h2>
    </header>
    
    <nav id="nav-bar">
        <!-- Menu déroulant principal pour sélectionner l'interface et déconnexion -->
        <select id="section-select" onchange="changeSection(this.value)">
            <option value="maintenance">Maintenance</option>
            <option value="it">IT</option>
            <option value="biomed">Biomed</option>
            <option value="logout">Déconnexion</option>
        </select>
    </nav>
    
    <main id="main-content">
        <!-- Le contenu sera chargé dynamiquement ici -->
    </main>
    
    <footer>
        <p>Application créée par Grok - xAI. Données synchronisées via Firebase.</p>
    </footer>
    
    <script>
        // Config Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCINxUOpfRmBesyEbGNg6IjevSGWacoUqE",
            authDomain: "maintenance-cmdk-6613a.firebaseapp.com",
            databaseURL: "https://maintenance-cmdk-6613a-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "maintenance-cmdk-6613a",
            storageBucket: "maintenance-cmdk-6613a.firebasestorage.app",
            messagingSenderId: "113245925666",
            appId: "1:113245925666:web:placeholder"  // Ajoute une app Web dans Firebase pour le vrai appId
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        const adminEmail = "mkhalife@cmd.cd";
        let currentUser = null;
        let currentSection = 'maintenance';  // Section par défaut
        let tasksChart = null;
        const maintenanceSites = ['CMDG', 'CMDN', 'CMDLT', 'CMDB', 'Manhattan', 'Residence'];

        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (user) {
                loadInterface(currentSection);
                openTab('dashboard');
            } else {
                loadLogin();
            }
        });

        function changeSection(value) {
            if (value === 'logout') {
                logout();
                document.getElementById('section-select').value = 'maintenance'; // Reset menu après logout
                return;
            }
            currentSection = value;
            loadInterface(currentSection);
            openTab('dashboard');
        }

        function loadLogin() {
            const main = document.getElementById('main-content');
            main.innerHTML = `
                <div id="login" class="tab-content active">
                    <h2>Connexion</h2>
                    <form id="form-login">
                        <input type="email" id="email" placeholder="Email" required>
                        <input type="password" id="password" placeholder="Mot de passe" required>
                        <button type="button" onclick="login()">Se connecter</button>
                        <button type="button" onclick="register()">S'inscrire</button>
                    </form>
                    <p id="login-message"></p>
                    <p id="error-message"></p>
                </div>
            `;
        }

        function loadInterface(section) {
            const nav = document.getElementById('nav-bar');
            const main = document.getElementById('main-content');
            main.innerHTML = '';

            // Nettoyage des boutons existants (garder le select)
            nav.querySelectorAll('button').forEach(btn => btn.remove());

            // Ajoute les boutons pour tabs communs
            const commonTabs = [
                {id: 'dashboard', label: 'Tableau de Bord'},
                {id: 'userManagement', label: 'Gestion des Utilisateurs'},
                {id: 'reports', label: 'Rapports'},
                {id: 'completed-tasks', label: 'Tâches Terminées'}
            ];
            commonTabs.forEach(tab => {
                const btn = document.createElement('button');
                btn.textContent = tab.label;
                btn.onclick = () => openTab(tab.id);
                nav.appendChild(btn);
            });

            // Ajoute tab "Tâches à Suivre" pour IT/Biomed, ou sites pour Maintenance
            if (section !== 'maintenance') {
                const btn = document.createElement('button');
                btn.textContent = 'Tâches à Suivre';
                btn.onclick = () => openTab('tasks');
                nav.appendChild(btn);
            } else {
                maintenanceSites.forEach(site => {
                    const btn = document.createElement('button');
                    btn.textContent = site;
                    btn.onclick = () => openTab(site);
                    nav.appendChild(btn);
                });
            }

            // Création des divs pour tabs (comme avant)
            // (Pour brevité, je réutilise la structure du code précédent – elle est identique)

            // Charge les données après création des éléments
            chargerTousDonnees();
        }

        // Les autres fonctions (openTab, login, register, logout, ajouterTache, etc.) sont identiques au code précédent et adaptées à currentSection.
        // Elles marchent maintenant avec le nettoyage de nav.
        // Par exemple, openTab ajoute console.log('Ouverture de tab: ' + tabId); pour debug – supprime si besoin.

        // Initialisation
        loadLogin();
    </script>
</body>
</html>

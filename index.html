<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance CMDK</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo="> <!-- Fix favicon 404 error -->
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f8f9fa; display: flex; flex-direction: column; min-height: 100vh; }
        header { background-color: #fd7e14; color: white; padding: 10px; text-align: center; position: relative; }
        #section-select { position: absolute; top: 10px; right: 10px; padding: 5px; font-size: 14px; background-color: #fd7e14; color: white; border: none; border-radius: 5px; cursor: pointer; width: auto; }
        nav { background-color: #e9ecef; padding: 10px; display: flex; justify-content: center; flex-wrap: wrap; align-items: center; }
        nav button { margin: 5px; padding: 10px 15px; background-color: #fd7e14; color: white; border: none; border-radius: 5px; cursor: pointer; }
        nav button:hover { background-color: #e06c0e; }
        main { flex: 1; padding: 20px; max-width: 100%; overflow-x: auto; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #fd7e14; color: white; }
        form { margin-bottom: 20px; }
        input, select, textarea { width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box; }
        button { padding: 10px; background-color: #fd7e14; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #e06c0e; }
        #error-message { color: red; }
        #tasksChart { max-width: 400px; margin: 20px auto; }
        .no-data { text-align: center; color: #666; padding: 10px; }
        .admin-only { display: none; }
        .overdue { color: red; }
        .crit-high-red { color: red; font-weight: bold; }
        .crit-medium-orange { color: orange; font-weight: bold; }
        .crit-low-green { color: green; font-weight: bold; }
        #week-selector { margin: 10px 0; text-align: center; }
        .comment-section { margin-top: 10px; }
        .priority-alert { color: red; font-weight: bold; }
        .checkbox-table td { vertical-align: middle; }
        .checkbox-table input[type="checkbox"] { transform: scale(1.5); margin-right: 10px; }
        #dept-select { margin: 10px 0; width: 200px; }
        #task-select { margin: 10px 0; width: 300px; }
        #task-list-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid #ddd; z-index: 1000; max-height: 80vh; overflow-y: auto; }
        .task-item { cursor: pointer; padding: 10px; border: 1px solid #ddd; margin-bottom: 5px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        .task-item:hover { background-color: #f0f0f0; }
        #task-detail { display: none; margin-top: 20px; border: 1px solid #ddd; padding: 10px; border-radius: 5px; }
        .due-month { background-color: #d4edda; } /* Vert clair pour mois dus */
        #annual-table th:nth-child(2), #annual-table td:nth-child(2) { width: 150px; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; } /* Responsable */
        #annual-table th:nth-child(3), #annual-table td:nth-child(3) { width: 300px; } /* Commentaire */
        #annual-table th:nth-child(4), #annual-table td:nth-child(4) { width: 100px; } /* Checkbox */
        #annual-table th:nth-child(5), #annual-table td:nth-child(5) { width: 100px; } /* Status (dernier) */
        #filter-due { margin: 10px 0; }
        @media (max-width: 600px) { nav { flex-direction: column; } table { font-size: 12px; } }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- iCal for calendar export -->
    <script src="https://cdn.jsdelivr.net/npm/ical-generator@3.1.0/build/ical.min.js"></script>
</head>
<body>
    <header>
        <h1>Maintenance CMDK</h1>
        <h2>Suivi des tâches</h2>
        <select id="section-select" onchange="changeSection(this.value)" disabled>
            <option value="maintenance">Maintenance</option>
            <option value="it">IT</option>
            <option value="biomed">Biomed</option>
            <option value="preventive">Maintenance Préventive</option>
            <option value="planning">Planning Hebdomadaire</option>
            <option value="logout">Déconnexion</option>
        </select>
    </header>
    
    <nav id="nav-bar"></nav>
    
    <main id="main-content"></main>
    
    <!-- Modal for full task list -->
    <div id="task-list-modal">
        <h3>Liste des Tâches Préventives</h3>
        <div id="task-list-content"></div>
        <button onclick="closeTaskListModal()">Fermer</button>
    </div>
    
    <script>
        // Remplace par TES clés Firebase réelles !
        const firebaseConfig = {
            apiKey: "AIzaSyBoQtCgGc2l7Myvig91dJ_rP9Bn0wZxgLU", // Remplace par ta clé
            authDomain: "maintenance-cmdk-6613a.firebaseapp.com", // Remplace
            databaseURL: "https://maintenance-cmdk-6613a-default-rtdb.europe-west1.firebasedatabase.app", // Remplace
            projectId: "maintenance-cmdk-6613a", // Remplace
            storageBucket: "maintenance-cmdk-6613a.firebasestorage.app", // Remplace
            messagingSenderId: "113245925666", // Remplace
            appId: "1:113245925666:web:be055abeb157e90e74357b", // Remplace
            measurementId: "G-R5GYPC5SMZ" // Remplace
        };

        try {
            firebase.initializeApp(firebaseConfig);
            console.log('Firebase initialisé avec succès');
        } catch (err) {
            console.error('Erreur Firebase init:', err);
            alert('Erreur de configuration Firebase: ' + err.message + '. Vérifiez vos clés.');
        }
        const db = firebase.database();
        const auth = firebase.auth();

        const adminEmails = ["mkhalife@cmd.cd", "mmbongo@cmd.cd"];
        let currentUser = null;
        let currentSection = 'maintenance';
        let tasksChart = null;
        const maintenanceSites = ['CMDG', 'CMDN', 'CMDLT', 'CMDB', 'Manhattan', 'Residence'];
        const allSections = ['maintenance', 'it', 'biomed'];
        const preventiveDepts = ['maintenance', 'it', 'biomed'];
        const preventiveTemplates = {
            maintenance: ['Climatiseurs', 'Électricité', 'Plomberie', 'Ascenseurs'],
            it: ['Sauvegardes serveurs', 'Mises à jour logiciels', 'Vérification réseaux', 'Sécurité firewalls'],
            biomed: ['Calibration équipements', 'Stérilisation', 'Tests de sécurité', 'Vérification batteries']
        };
        const checklistSuggestions = {
            'Climatiseurs': 'Vérifier filtres, Nettoyer conduits, Tester refroidissement, Inspecter fuites',
            'Électricité': 'Vérifier câblages, Tester disjoncteurs, Contrôler éclairage',
            // Ajoute plus pour d'autres templates si besoin
        };
        const months = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];

        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (user) {
                document.getElementById('section-select').disabled = false;
                loadInterface();
            } else {
                loadLogin();
            }
        });

        function changeSection(value) {
            if (value === 'logout') {
                logout();
                return;
            }
            currentSection = value;
            loadInterface();
            loadButtonsForSection();
            setTimeout(() => {
                openTab('dashboard');
                if (currentSection !== 'planning' && currentSection !== 'preventive') chargerTousDonnees();
            }, 100);
            console.log('Changed to section:', currentSection);
        }

        function loadLogin() {
            const main = document.getElementById('main-content');
            main.innerHTML = `
                <div id="login" class="tab-content active">
                    <h2>Connexion</h2>
                    <form id="form-login">
                        <input type="email" id="email" placeholder="Email" required>
                        <input type="password" id="password" placeholder="Mot de passe" required>
                        <button type="button" onclick="login()">Se connecter</button>
                        <button type="button" onclick="register()">S'inscrire</button>
                    </form>
                    <p id="login-message"></p>
                    <p id="error-message"></p>
                </div>
            `;
            document.getElementById('nav-bar').innerHTML = '';
            document.getElementById('section-select').disabled = true;
            document.getElementById('section-select').value = 'maintenance';
        }

        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    const messageElement = document.getElementById('login-message');
                    if (messageElement) messageElement.textContent = 'Connecté !';
                    loadInterface();
                })
                .catch(err => {
                    const errorElement = document.getElementById('error-message');
                    if (errorElement) errorElement.textContent = 'Erreur: ' + err.message;
                    console.error('Erreur de connexion:', err);
                });
        }

        function register() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            auth.createUserWithEmailAndPassword(email, password)
                .then(() => {
                    const messageElement = document.getElementById('login-message');
                    if (messageElement) messageElement.textContent = 'Inscrit ! Connecte-toi.';
                })
                .catch(err => {
                    const errorElement = document.getElementById('error-message');
                    if (errorElement) errorElement.textContent = 'Erreur: ' + err.message;
                    console.error('Erreur d\'inscription:', err);
                });
        }

        function logout() {
            auth.signOut().then(() => loadLogin());
        }

        function loadInterface() {
            const main = document.getElementById('main-content');
            if (!main) return console.error('Main content not found');
            main.innerHTML = '';
            // Tabs communs
            main.innerHTML += `
                <div id="dashboard" class="tab-content">
                    <h2>Tableau de Bord</h2>
                    <div class="stats">
                        <div class="stat" id="en-cours">Tâches en Cours : 0</div>
                        <div class="stat" id="terminees">Tâches Terminées : 0</div>
                        <div class="stat" id="en-attente">Tâches en Attente : 0</div>
                        <div class="stat" id="temps-moyen">Temps Moyen de Résolution : 0 jours</div>
                        <div class="stat" id="taux-completion">Taux de Completion : 0%</div>
                    </div>
                    <canvas id="tasksChart"></canvas>
                    <div id="priority-suggestions"></div>
                </div>
                <div id="userManagement" class="tab-content">
                    <h2>Gestion des Utilisateurs</h2>
                    <form id="form-userManagement">
                        <input type="email" id="newUserEmail" placeholder="Entrez l'email de l'utilisateur" required>
                        <button type="button" onclick="ajouterUtilisateur()">Ajouter Utilisateur</button>
                    </form>
                    <table id="table-users">
                        <thead><tr><th>Email</th><th>Actions</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div id="reports" class="tab-content">
                    <h2>Rapports pour ${currentSection.charAt(0).toUpperCase() + currentSection.slice(1)}</h2>
                    <button onclick="generateReports()">Générer Rapports</button>
                    <button onclick="sendAutoReport()">Envoyer Rapport Automatique (Simulation)</button>
                    <h3>Rapport Mensuel</h3>
                    <pre id="monthly-report"></pre>
                    <h3>Rapport Annuel</h3>
                    <pre id="annual-report"></pre>
                </div>
                <div id="completed-tasks" class="tab-content">
                    <h2>Tâches Terminées</h2>
                    <table id="table-completed">
                        <thead><tr><th>Tâche</th><th>Statut</th><th>Date</th><th>Responsable</th><th>Criticité</th><th>Checklist</th><th>Signature</th></tr></thead>
                        <tbody></tbody>
                    </table>
                    <button type="button" onclick="effacerToutesDonneesTerminees()">Effacer Toutes les Tâches Terminées</button>
                </div>
            `;
            // Tabs spécifiques (le reste est identique, mais voici la section preventive mise à jour)
            if (currentSection === 'preventive') {
                main.innerHTML += `
                    <div id="preventive-tab" class="tab-content active">
                        <h2>Maintenance Préventive</h2>
                        <p>Sélectionnez un département pour gérer les tâches préventives.</p>
                        <select id="dept-select" onchange="loadTaskDropdown(this.value)">
                            <option value="">Choisissez un département</option>
                            <option value="maintenance">Maintenance</option>
                            <option value="it">IT</option>
                            <option value="biomed">Biomed</option>
                        </select>
                        <button id="add-task-btn" style="display:none;" onclick="showAddTaskForm()">Ajouter une Tâche Préventive</button>
                        <button id="list-task-btn" style="display:none;" onclick="showTaskListModal()">Liste de Maintenance Préventive</button>
                        <select id="task-select" style="display:none;" onchange="loadTaskDetail(this.value)">
                            <option value="">Sélectionnez une tâche</option>
                        </select>
                        <div id="add-task-form" style="display:none;">
                            <h3 id="add-task-title">Ajouter Tâche Préventive</h3>
                            <form id="task-form">
                                <input type="text" id="task-name" placeholder="Nom de la tâche (ex: Climatiseurs)" required>
                                <select id="task-freq" required>
                                    <option value="">Fréquence</option>
                                    <option value="daily">Quotidien</option>
                                    <option value="weekly">Hebdomadaire</option>
                                    <option value="monthly">Mensuel</option>
                                    <option value="bimonthly">Bimestriel (chaque 2 mois)</option>
                                    <option value="trimonthly">Trimestriel (chaque 3 mois)</option>
                                    <option value="quadmonthly">Quadrimestriel (chaque 4 mois)</option>
                                    <option value="semiannual">Semestriel (chaque 6 mois)</option>
                                    <option value="annual">Annuel</option>
                                    <option value="biannual">Bi-annuel (chaque 2 ans)</option>
                                </select>
                                <select id="task-resp" required>
                                    <option value="">Responsable</option>
                                </select>
                                <textarea id="task-checklist" placeholder="Checklist (séparée par virgules, ex: Vérifier filtres, Nettoyer)"></textarea>
                                <button type="button" onclick="saveTask()">Sauvegarder</button>
                            </form>
                            <h4>Suggestions de Tâches (cliquez pour pré-remplir)</h4>
                            <ul id="task-templates"></ul>
                        </div>
                        <div id="task-detail" style="display:none;">
                            <h3 id="detail-title"></h3>
                            <select id="year-select" onchange="loadAnnualPlanning()"></select>
                            <label id="filter-due"><input type="checkbox" onchange="filterDueMonths(this.checked)"> Afficher seulement mois dus</label>
                            <table id="annual-table">
                                <thead><tr><th>Mois</th><th>Responsable</th><th>Commentaires</th><th>Validé ?</th><th>Statut</th></tr></thead>
                                <tbody id="annual-body"></tbody>
                            </table>
                            <button onclick="saveAnnualPlanning()">Sauvegarder Planning</button>
                            <button onclick="generateTasksFromPlanning()">Générer Tâches Automatiques</button>
                            <button onclick="exportAnnualToPDF()">Exporter Planning Annuel en PDF</button>
                        </div>
                    </div>
                `;
                // Le reste du code pour les autres sections est identique à la version précédente pour éviter la longueur
            } // (Ajoute ici les autres conditions pour 'planning', 'tasks', etc., comme dans la version précédente)

            loadButtonsForSection();
            if (currentSection !== 'planning' && currentSection !== 'preventive') chargerTousDonnees();
            if (currentSection === 'preventive') openTab('preventive-tab');
            else openTab('dashboard');
            checkAdminAndShowElements();
            console.log('Interface chargée pour section:', currentSection);
        }

        // ... (Le reste du code JS est identique, mais voici les fonctions mises à jour pour preventive)
        // Fonctions pour Maintenance Préventive (mises à jour)
        let selectedDept = '';
        let selectedTaskKey = '';
        let selectedTask = null;
        let selectedYear = new Date().getFullYear();
        let isEditing = false;
        let dueMonthsFilter = false;

        function loadTaskDropdown(dept) {
            selectedDept = dept;
            const addBtn = document.getElementById('add-task-btn');
            const listBtn = document.getElementById('list-task-btn');
            const taskSelect = document.getElementById('task-select');
            const detail = document.getElementById('task-detail');
            if (addBtn) addBtn.style.display = dept ? 'inline-block' : 'none';
            if (listBtn) listBtn.style.display = dept ? 'inline-block' : 'none';
            if (taskSelect) taskSelect.style.display = dept ? 'inline-block' : 'none';
            if (detail) detail.style.display = 'none';
            if (!dept || !taskSelect) return;
            taskSelect.innerHTML = '<option value="">Sélectionnez une tâche</option>';
            db.ref(`preventive/tasks/${dept}`).once('value', snapshot => {
                snapshot.forEach(child => {
                    const item = child.val();
                    const option = document.createElement('option');
                    option.value = child.key;
                    option.textContent = `${item.tache} (${item.frequence})`;
                    taskSelect.appendChild(option);
                });
            });
        }

        function showTaskListModal() {
            const modal = document.getElementById('task-list-modal');
            const content = document.getElementById('task-list-content');
            if (!modal || !content) return;
            content.innerHTML = '';
            db.ref(`preventive/tasks/${selectedDept}`).once('value', snapshot => {
                if (!snapshot.exists()) {
                    content.innerHTML = '<p class="no-data">Aucune tâche préventive.</p>';
                } else {
                    snapshot.forEach(child => {
                        const item = child.val();
                        const div = document.createElement('div');
                        div.classList.add('task-item');
                        const textSpan = document.createElement('span');
                        textSpan.textContent = `${item.tache} (${item.frequence})`;
                        textSpan.onclick = () => {
                            closeTaskListModal();
                            document.getElementById('task-select').value = child.key;
                            loadTaskDetail(child.key);
                        };
                        div.appendChild(textSpan);
                        const editBtn = document.createElement('button');
                        editBtn.textContent = 'Modifier';
                        editBtn.onclick = () => {
                            closeTaskListModal();
                            showAddTaskForm(child.key, item);
                        };
                        div.appendChild(editBtn);
                        content.appendChild(div);
                    });
                }
            });
            modal.style.display = 'block';
        }

        function closeTaskListModal() {
            document.getElementById('task-list-modal').style.display = 'none';
        }

        function loadTaskDetail(key) {
            if (!key) return;
            db.ref(`preventive/tasks/${selectedDept}/${key}`).once('value', snapshot => {
                selectedTaskKey = key;
                selectedTask = snapshot.val();
                const detail = document.getElementById('task-detail');
                const title = document.getElementById('detail-title');
                if (detail) detail.style.display = 'block';
                if (title) title.textContent = `${selectedTask.tache} - Fréquence: ${selectedTask.frequence} - Responsable par défaut: ${selectedTask.responsable}`;
                loadYearSelect();
                loadAnnualPlanning();
            });
        }

        function showAddTaskForm(key = null, task = null) {
            const form = document.getElementById('add-task-form');
            const title = document.getElementById('add-task-title');
            if (form) form.style.display = 'block';
            if (title) title.textContent = key ? 'Modifier Tâche Préventive' : 'Ajouter Tâche Préventive';
            isEditing = !!key;
            selectedTaskKey = key;
            document.getElementById('task-name').value = task ? task.tache : '';
            document.getElementById('task-freq').value = task ? task.frequence : '';
            document.getElementById('task-resp').value = task ? task.responsable : '';
            document.getElementById('task-checklist').value = task ? task.checklist.map(i => i.text).join(', ') : '';
            loadTaskTemplates(selectedDept);
            loadPrestatairesForPreventive('task-resp');
        }

        function loadTaskTemplates(dept) {
            const list = document.getElementById('task-templates');
            if (!list) return;
            list.innerHTML = '';
            preventiveTemplates[dept].forEach(template => {
                const li = document.createElement('li');
                li.textContent = template;
                li.style.cursor = 'pointer';
                li.onclick = () => {
                    document.getElementById('task-name').value = template;
                    document.getElementById('task-checklist').value = checklistSuggestions[template] || '';
                };
                list.appendChild(li);
            });
        }

        function loadPrestatairesForPreventive(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            db.ref('authorizedUsers').once('value', snapshot => {
                select.innerHTML = '<option value="">Responsable</option>';
                snapshot.forEach(child => {
                    const email = child.val();
                    const option = document.createElement('option');
                    option.value = email;
                    option.textContent = email;
                    select.appendChild(option);
                });
            });
        }

        function saveTask() {
            const tache = document.getElementById('task-name').value;
            const frequence = document.getElementById('task-freq').value;
            const responsable = document.getElementById('task-resp').value;
            const checklistStr = document.getElementById('task-checklist').value;
            const checklist = checklistStr ? checklistStr.split(',').map(d => ({ text: d.trim(), checked: false })) : [];
            if (!tache || !frequence || !responsable) return alert('Remplissez tous les champs.');
            const data = { tache, frequence, responsable, checklist };
            const ref = db.ref(`preventive/tasks/${selectedDept}`);
            if (isEditing) {
                ref.child(selectedTaskKey).update(data);
                alert('Tâche modifiée !');
            } else {
                ref.push(data);
                alert('Tâche ajoutée !');
            }
            document.getElementById('add-task-form').style.display = 'none';
            loadTaskDropdown(selectedDept);
        }

        function loadYearSelect() {
            const select = document.getElementById('year-select');
            if (!select) return;
            select.innerHTML = '';
            const currentYear = new Date().getFullYear();
            for (let y = currentYear - 5; y <= 2030; y++) {
                const option = document.createElement('option');
                option.value = y;
                option.textContent = y;
                if (y === selectedYear) option.selected = true;
                select.appendChild(option);
            }
        }

        function loadAnnualPlanning() {
            selectedYear = parseInt(document.getElementById('year-select').value);
            const body = document.getElementById('annual-body');
            if (!body) return;
            body.innerHTML = '';
            db.ref(`preventive/tasks/${selectedDept}/${selectedTaskKey}/annualPlans/${selectedYear}`).once('value', snapshot => {
                let planning = snapshot.val() || months.map(() => ({ responsible: selectedTask.responsable, comments: '', validated: false, statut: 'En attente' }));
                const dueMonths = calculateDueMonths(new Date(), selectedTask.frequence, selectedYear);
                months.forEach((month, index) => {
                    if (dueMonthsFilter && !dueMonths.includes(index)) return;
                    const row = body.insertRow();
                    row.dataset.monthIndex = index;
                    const monthCell = row.insertCell(0);
                    monthCell.textContent = month;
                    if (dueMonths.includes(index)) monthCell.classList.add('due-month');
                    const respCell = row.insertCell(1);
                    const respSelect = document.createElement('select');
                    db.ref('authorizedUsers').once('value', snap => {
                        snap.forEach(child => {
                            const email = child.val();
                            const option = document.createElement('option');
                            option.value = email;
                            option.textContent = email;
                            if (email === planning[index].responsible) option.selected = true;
                            respSelect.appendChild(option);
                        });
                    });
                    respCell.appendChild(respSelect);
                    const commentsCell = row.insertCell(2);
                    commentsCell.innerHTML = `<input type="text" value="${planning[index].comments || ''}">`;
                    const checkboxCell = row.insertCell(3);
                    checkboxCell.innerHTML = '<label>Validé ?</label>'; // Label ajouté
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = planning[index].validated;
                    checkbox.onchange = () => {
                        if (checkbox.checked && confirm('Valider ce mois ? Cela mettra le statut à Terminé et marquera la checklist comme complétée.')) {
                            planning[index].validated = true;
                            planning[index].statut = 'Terminé';
                            // Marquer toute la checklist comme checked
                            if (selectedTask.checklist) selectedTask.checklist.forEach(item => item.checked = true);
                            // Update status select
                            const statusSelect = row.cells[4].querySelector('select');
                            statusSelect.value = 'Terminé';
                            statusSelect.disabled = true;
                            checkbox.disabled = true;
                        } else {
                            checkbox.checked = false;
                        }
                    };
                    if (planning[index].statut === 'Terminé') checkbox.disabled = true; // Disable si déjà Terminé
                    checkboxCell.appendChild(checkbox);
                    const statutCell = row.insertCell(4); // Status en dernier
                    const statutSelect = document.createElement('select');
                    ['En attente', 'En cours', 'Terminé'].forEach(stat => {
                        const opt = document.createElement('option');
                        opt.value = stat;
                        opt.textContent = stat;
                        if (stat === planning[index].statut) opt.selected = true;
                        statutSelect.appendChild(opt);
                    });
                    if (planning[index].statut === 'Terminé') statutSelect.disabled = true;
                    statutCell.appendChild(statutSelect);
                });
            });
        }

        function filterDueMonths(checked) {
            dueMonthsFilter = checked;
            loadAnnualPlanning();
        }

        function calculateDueMonths(startDate, frequence, year) {
            const due = [];
            const freqMap = {
                daily: 1 / 30, weekly: 1 / 4, monthly: 1, bimonthly: 2, trimonthly: 3, quadmonthly: 4, 
                semiannual: 6, annual: 12, biannual: 24
            };
            const interval = freqMap[frequence] || 1;
            let current = new Date(startDate); // Use current date as fallback since date is removed
            while (current.getFullYear() < year) {
                current.setMonth(current.getMonth() + interval);
            }
            while (current.getFullYear() === year) {
                due.push(current.getMonth());
                current.setMonth(current.getMonth() + interval);
                if (current.getFullYear() > year) break;
            }
            return due;
        }

        function saveAnnualPlanning() {
            const body = document.getElementById('annual-body');
            if (!body) return;
            const planning = [];
            Array.from(body.rows).forEach(row => {
                const index = parseInt(row.dataset.monthIndex);
                planning[index] = {
                    responsible: row.cells[1].querySelector('select').value,
                    comments: row.cells[2].querySelector('input').value,
                    validated: row.cells[3].querySelector('input').checked,
                    statut: row.cells[4].querySelector('select').value
                };
            });
            db.ref(`preventive/tasks/${selectedDept}/${selectedTaskKey}/annualPlans/${selectedYear}`).set(planning);
            alert('Planning annuel sauvegardé !');
        }

        function generateTasksFromPlanning() {
            db.ref(`preventive/tasks/${selectedDept}/${selectedTaskKey}/annualPlans/${selectedYear}`).once('value', snapshot => {
                const planning = snapshot.val() || [];
                const dueMonths = calculateDueMonths(new Date(), selectedTask.frequence, selectedYear);
                const refPath = selectedDept === 'maintenance' ? `${selectedDept}/tasks/CMDG` : `${selectedDept}/tasks`; // Default site for maintenance
                dueMonths.forEach(monthIndex => {
                    const monthData = planning[monthIndex] || { statut: 'En attente', responsible: selectedTask.responsable, comments: '' };
                    if (monthData.statut === 'Terminé') return; // Skip si Terminé
                    const nextDate = new Date(selectedYear, monthIndex, 1).toISOString().split('T')[0]; // Premier du mois
                    db.ref(refPath).push({
                        tache: `${selectedTask.tache} (Préventive) - ${months[monthIndex]}`,
                        statut: monthData.statut,
                        date: nextDate,
                        dateButoir: nextDate,
                        responsable: monthData.responsable,
                        criticite: '3',
                        comments: [monthData.comments],
                        checklist: selectedTask.checklist ? JSON.parse(JSON.stringify(selectedTask.checklist)) : []
                    });
                });
                alert('Tâches générées pour les mois dus (non terminés) !');
            });
        }

        function exportAnnualToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(`${selectedTask.tache} - Planning Annuel ${selectedYear}`, 10, 10);
            let y = 20;
            const rows = document.querySelectorAll('#annual-body tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const isDue = row.querySelector('.due-month') ? ' (Due)' : '';
                doc.text(`${cells[0].textContent}${isDue} - Responsable: ${cells[1].querySelector('select').value} - Commentaires: ${cells[2].querySelector('input').value} - Validé: ${cells[3].querySelector('input').checked ? 'Oui' : 'Non'} - Statut: ${cells[4].querySelector('select').value}`, 10, y);
                y += 10;
            });
            doc.save(`${selectedTask.tache}_annual_${selectedYear}.pdf`);
        }

        // (Le reste du code JS pour les autres sections est identique à la version précédente)
    </script>
</body>
</html>

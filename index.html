<!DOCTYPE html>  
<html lang="fr">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>Maintenance CMDK</title>  
    <link rel="icon" href="data:;base64,iVBORw0KGgo="> <!-- Fix favicon 404 error -->  
    <style>  
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f8f9fa; display: flex; flex-direction: column; min-height: 100vh; }  
        header { background-color: #fd7e14; color: white; padding: 10px; text-align: center; position: relative; }  
        #section-select { position: absolute; top: 10px; right: 10px; padding: 5px; font-size: 14px; background-color: #fd7e14; color: white; border: none; border-radius: 5px; cursor: pointer; width: auto; }  
        nav { background-color: #e9ecef; padding: 10px; display: flex; justify-content: center; flex-wrap: wrap; align-items: center; }  
        nav button { margin: 5px; padding: 10px 15px; background-color: #fd7e14; color: white; border: none; border-radius: 5px; cursor: pointer; }  
        nav button:hover { background-color: #e06c0e; }  
        main { flex: 1; padding: 20px; max-width: 100%; overflow-x: auto; }  
        .tab-content { display: none; }  
        .tab-content.active { display: block; }  
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }  
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }  
        th { background-color: #fd7e14; color: white; }  
        form { margin-bottom: 20px; }  
        input, select, textarea { width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box; }  
        button { padding: 10px; background-color: #fd7e14; color: white; border: none; border-radius: 5px; cursor: pointer; }  
        button:hover { background-color: #e06c0e; }  
        #error-message { color: red; }  
        #tasksChart { max-width: 400px; margin: 20px auto; }  
        .no-data { text-align: center; color: #666; padding: 10px; }  
        .admin-only { display: none; }  
        .overdue { color: red; }  
        .crit-high-red { color: red; font-weight: bold; }  
        .crit-medium-orange { color: orange; font-weight: bold; }  
        .crit-low-green { color: green; font-weight: bold; }  
        #week-selector { margin: 10px 0; text-align: center; }  
        .comment-section { margin-top: 10px; }  
        .priority-alert { color: red; font-weight: bold; }  
        .checkbox-table td { vertical-align: middle; }  
        .checkbox-table input[type="checkbox"] { transform: scale(1.5); margin-right: 10px; }  
        #dept-select { margin: 10px 0; width: 200px; }  
        #task-select { margin: 10px 0; width: 300px; }  
        #task-list-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid #ddd; z-index: 1000; max-height: 80vh; overflow-y: auto; }  
        .task-item { cursor: pointer; padding: 10px; border: 1px solid #ddd; margin-bottom: 5px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }  
        .task-item:hover { background-color: #f0f0f0; }  
        #task-detail { display: none; margin-top: 20px; border: 1px solid #ddd; padding: 10px; border-radius: 5px; }  
        .due-month { background-color: #d4edda; } /* Vert clair pour mois dus */  
        #annual-table th:nth-child(2), #annual-table td:nth-child(2) { width: 150px; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; } /* Responsable */  
        #annual-table th:nth-child(3), #annual-table td:nth-child(3) { width: 300px; } /* Commentaire */  
        #annual-table th:nth-child(4), #annual-table td:nth-child(4) { width: 100px; } /* Checkbox */  
        #annual-table th:nth-child(5), #annual-table td:nth-child(5) { width: 100px; } /* Status (dernier) */  
        #filter-due { margin: 10px 0; }  
        @media (max-width: 600px) { nav { flex-direction: column; } table { font-size: 12px; } }  
    </style>  
    <!-- Firebase SDK -->  
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>  
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>  
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>  
    <!-- Chart.js -->  
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>  
    <!-- jsPDF for PDF export -->  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>  
    <!-- iCal for calendar export -->  
    <script src="https://cdn.jsdelivr.net/npm/ical-generator@3.1.0/build/ical.min.js"></script>  
</head>  
<body>  
    <header>  
        <h1>Maintenance CMDK</h1>  
        <h2>Suivi des tâches</h2>  
        <select id="section-select" onchange="changeSection(this.value)" disabled>  
            <option value="maintenance">Maintenance</option>  
            <option value="it">IT</option>  
            <option value="biomed">Biomed</option>  
            <option value="preventive">Maintenance Préventive</option>  
            <option value="planning">Planning Hebdomadaire</option>  
            <option value="logout">Déconnexion</option>  
        </select>  
    </header>  
    
    <nav id="nav-bar"></nav>  
    
    <main id="main-content"></main>  
    
    <!-- Modal for full task list -->  
    <div id="task-list-modal">  
        <h3>Liste des Tâches Préventives</h3>  
        <div id="task-list-content"></div>  
        <button onclick="closeTaskListModal()">Fermer</button>  
    </div>  
    
    <script>  
        const firebaseConfig = {  
            apiKey: "AIzaSyBoQtCgGc2l7Myvig91dJ_rP9Bn0wZxgLU",  
            authDomain: "maintenance-cmdk-6613a.firebaseapp.com",  
            databaseURL: "https://maintenance-cmdk-6613a-default-rtdb.europe-west1.firebasedatabase.app",  
            projectId: "maintenance-cmdk-6613a",  
            storageBucket: "maintenance-cmdk-6613a.firebasestorage.app",  
            messagingSenderId: "113245925666",  
            appId: "1:113245925666:web:be055abeb157e90e74357b",  
            measurementId: "G-R5GYPC5SMZ"  
        };  

        firebase.initializeApp(firebaseConfig);  
        const db = firebase.database();  
        const auth = firebase.auth();  

        const adminEmails = ["mkhalife@cmd.cd", "mmbongo@cmd.cd"];  
        let currentUser = null;  
        let currentSection = 'maintenance';  
        let tasksChart = null;  
        const maintenanceSites = ['CMDG', 'CMDN', 'CMDLT', 'CMDB', 'Manhattan', 'Residence'];  
        const allSections = ['maintenance', 'it', 'biomed'];  
        const preventiveDepts = ['maintenance', 'it', 'biomed'];  
        const preventiveTemplates = {  
            maintenance: ['Climatiseurs', 'Électricité', 'Plomberie', 'Ascenseurs'],  
            it: ['Sauvegardes serveurs', 'Mises à jour logiciels', 'Vérification réseaux', 'Sécurité firewalls'],  
            biomed: ['Calibration équipements', 'Stérilisation', 'Tests de sécurité', 'Vérification batteries']  
        };  
        const checklistSuggestions = {  
            'Climatiseurs': 'Vérifier filtres, Nettoyer conduits, Tester refroidissement, Inspecter fuites',  
            'Électricité': 'Vérifier câblages, Tester disjoncteurs, Contrôler éclairage',  
            // Ajoute plus pour d'autres templates si besoin  
        };  
        const months = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];  

        auth.onAuthStateChanged(user => {  
            currentUser = user;  
            if (user) {  
                document.getElementById('section-select').disabled = false;  
                loadInterface();  
            } else {  
                loadLogin();  
            }  
        });  

        function changeSection(value) {  
            if (value === 'logout') {  
                logout();  
                return;  
            }  
            currentSection = value;  
            loadInterface();  
            loadButtonsForSection();  
            setTimeout(() => {  
                openTab('dashboard');  
                if (currentSection !== 'planning' && currentSection !== 'preventive') chargerTousDonnees();  
            }, 100);  
            console.log('Changed to section:', currentSection);  
        }  

        function loadLogin() {  
            const main = document.getElementById('main-content');  
            main.innerHTML = `  
                <div id="login" class="tab-content active">  
                    <h2>Connexion</h2>  
                    <form id="form-login">  
                        <input type="email" id="email" placeholder="Email" required>  
                        <input type="password" id="password" placeholder="Mot de passe" required>  
                        <button type="button" onclick="login()">Se connecter</button>  
                        <button type="button" onclick="register()">S'inscrire</button>  
                    </form>  
                    <p id="login-message"></p>  
                    <p id="error-message"></p>  
                </div>  
            `;  
            document.getElementById('nav-bar').innerHTML = '';  
            document.getElementById('section-select').disabled = true;  
            document.getElementById('section-select').value = 'maintenance';  
        }  

        function login() {  
            const email = document.getElementById('email').value;  
            const password = document.getElementById('password').value;  
            auth.signInWithEmailAndPassword(email, password)  
                .then(() => {  
                    const messageElement = document.getElementById('login-message');  
                    if (messageElement) messageElement.textContent = 'Connecté !';  
                    loadInterface();  
                })  
                .catch(err => {  
                    const errorElement = document.getElementById('error-message');  
                    if (errorElement) errorElement.textContent = 'Erreur: ' + err.message;  
                    console.error('Erreur de connexion:', err);  
                });  
        }  

        function register() {  
            const email = document.getElementById('email').value;  
            const password = document.getElementById('password').value;  
            auth.createUserWithEmailAndPassword(email, password)  
                .then(() => {  
                    const messageElement = document.getElementById('login-message');  
                    if (messageElement) messageElement.textContent = 'Inscrit ! Connecte-toi.';  
                })  
                .catch(err => {  
                    const errorElement = document.getElementById('error-message');  
                    if (errorElement) errorElement.textContent = 'Erreur: ' + err.message;  
                    console.error('Erreur d\'inscription:', err);  
                });  
        }  

        function logout() {  
            auth.signOut().then(() => loadLogin());  
        }  

        function loadInterface() {  
            const main = document.getElementById('main-content');  
            main.innerHTML = '';  
            // Tabs communs (sans audit-logs)  
            main.innerHTML += `  
                <div id="dashboard" class="tab-content">  
                    <h2>Tableau de Bord</h2>  
                    <div class="stats">  
                        <div class="stat" id="en-cours">Tâches en Cours : 0</div>  
                        <div class="stat" id="terminees">Tâches Terminées : 0</div>  
                        <div class="stat" id="en-attente">Tâches en Attente : 0</div>  
                        <div class="stat" id="temps-moyen">Temps Moyen de Résolution : 0 jours</div>  
                        <div class="stat" id="taux-completion">Taux de Completion : 0%</div>  
                    </div>  
                    <canvas id="tasksChart"></canvas>  
                    <div id="priority-suggestions"></div>  
                </div>  
                <div id="userManagement" class="tab-content">  
                    <h2>Gestion des Utilisateurs</h2>  
                    <form id="form-userManagement">  
                        <input type="email" id="newUserEmail" placeholder="Entrez l'email de l'utilisateur" required>  
                        <button type="button" onclick="ajouterUtilisateur()">Ajouter Utilisateur</button>  
                    </form>  
                    <table id="table-users">  
                        <thead><tr><th>Email</th><th>Actions</th></tr></thead>  
                        <tbody></tbody>  
                    </table>  
                </div>  
                <div id="reports" class="tab-content">  
                    <h2>Rapports pour ${currentSection.charAt(0).toUpperCase() + currentSection.slice(1)}</h2>  
                    <button onclick="generateReports()">Générer Rapports</button>  
                    <button onclick="sendAutoReport()">Envoyer Rapport Automatique (Simulation)</button>  
                    <h3>Rapport Mensuel</h3>  
                    <pre id="monthly-report"></pre>  
                    <h3>Rapport Annuel</h3>  
                    <pre id="annual-report"></pre>  
                </div>  
                <div id="completed-tasks" class="tab-content">  
                    <h2>Tâches Terminées</h2>  
                    <table id="table-completed">  
                        <thead><tr><th>Tâche</th><th>Statut</th><th>Date</th><th>Responsable</th><th>Criticité</th><th>Checklist</th><th>Signature</th></tr></thead>  
                        <tbody></tbody>  
                    </table>  
                    <button type="button" onclick="effacerToutesDonneesTerminees()">Effacer Toutes les Tâches Terminées</button>  
                </div>  
            `;  
            // Tabs spécifiques  
            if (currentSection === 'planning') {  
                main.innerHTML += `  
                    <div id="planning-tab" class="tab-content">  
                        <h2>Planning Hebdomadaire par Prestataire</h2>  
                        <select id="prestataire-select" onchange="loadPlanning()">  
                            <option value="">Sélectionnez un prestataire</option>  
                        </select>  
                        <div id="week-selector">  
                            <button onclick="changeWeek(-1)">Semaine Précédente</button>  
                            <span id="week-display">Semaine courante</span>  
                            <button onclick="changeWeek(1)">Semaine Suivante</button>  
                        </div>  
                        <table id="table-planning">  
                            <thead><tr><th>Tâche</th><th>Date Début</th><th>Criticité</th><th>Date Butoir</th><th>Statut</th><th>Section</th><th>Commentaires</th><th>Checklist</th><th class="admin-only">Actions</th></tr></thead>  
                            <tbody></tbody>  
                        </table>  
                        <button onclick="exportPlanningToPDF()">Exporter Planning en PDF</button>  
                        <button onclick="exportPlanningToICal()">Exporter en iCal</button>  
                        <div class="admin-only" id="planning-actions">  
                            <button onclick="effacerPlanning()">Effacer le contenu du tableau</button>  
                            <button onclick="creerNouveauPlanning()">Créer un nouveau planning hebdomadaire</button>  
                        </div>  
                        <div id="new-planning-form" style="display:none;">  
                            <h3>Ajouter une Tâche au Planning</h3>  
                            <form id="form-new-planning">  
                                <input type="text" id="new-tache" placeholder="Description de la tâche" required>  
                                <select id="new-statut" required>  
                                    <option value="">Statut</option>  
                                    <option value="En cours">En cours</option>  
                                    <option value="En attente">En attente</option>  
                                </select>  
                                <input type="date" id="new-date-debut" placeholder="Date début" required>  
                                <input type="date" id="new-date-butoir" placeholder="Date butoir" required>  
                                <input type="text" id="new-responsable" readonly>  
                                <select id="new-criticite" required>  
                                    <option value="">Criticité (1-5)</option>  
                                    <option value="1">1 (Très Critique)</option>  
                                    <option value="2">2</option>  
                                    <option value="3">3</option>  
                                    <option value="4">4</option>  
                                    <option value="5">5 (Faible)</option>  
                                </select>  
                                <select id="new-section" required>  
                                    <option value="">Section</option>  
                                    <option value="maintenance">Maintenance (choisissez un site)</option>  
                                    <option value="it">IT</option>  
                                    <option value="biomed">Biomed</option>  
                                </select>  
                                <select id="new-site" style="display:none;" required>  
                                    <option value="">Site Maintenance</option>  
                                    <option value="CMDG">CMDG</option>  
                                    <option value="CMDN">CMDN</option>  
                                    <option value="CMDLT">CMDLT</option>  
                                    <option value="CMDB">CMDB</option>  
                                    <option value="Manhattan">Manhattan</option>  
                                    <option value="Residence">Residence</option>  
                                </select>  
                                <textarea id="new-checklist" placeholder="Checklist (séparée par virgules)"></textarea>  
                                <button type="button" onclick="ajouterTacheAuPlanning()">Ajouter Tâche</button>  
                            </form>  
                        </div>  
                    </div>  
                `;  
                loadPrestataires();  
                checkAdminAndShowElements();  
                const newSectionSelect = document.getElementById('new-section');  
                if (newSectionSelect) {  
                    newSectionSelect.onchange = function() {  
                        const newSite = document.getElementById('new-site');  
                        if (newSite) {  
                            newSite.style.display = this.value === 'maintenance' ? 'block' : 'none';  
                        }  
                    };  
                }  
            } else if (currentSection === 'preventive') {  
                main.innerHTML += `  
                    <div id="preventive-tab" class="tab-content active">  
                        <h2>Maintenance Préventive</h2>  
                        <p>Sélectionnez un département pour gérer les tâches préventives.</p>  
                        <select id="dept-select" onchange="loadTaskDropdown(this.value)">  
                            <option value="">Choisissez un département</option>  
                            <option value="maintenance">Maintenance</option>  
                            <option value="it">IT</option>  
                            <option value="biomed">Biomed</option>  
                        </select>  
                        <button id="add-task-btn" style="display:none;" onclick="showAddTaskForm()">Ajouter une Tâche Préventive</button>  
                        <button id="list-task-btn" style="display:none;" onclick="showTaskListModal()">Liste de Maintenance Préventive</button>  
                        <select id="task-select" style="display:none;" onchange="loadTaskDetail(this.value)">  
                            <option value="">Sélectionnez une tâche</option>  
                        </select>  
                        <div id="add-task-form" style="display:none;">  
                            <h3 id="add-task-title">Ajouter Tâche Préventive</h3>  
                            <form id="task-form">  
                                <input type="text" id="task-name" placeholder="Nom de la tâche (ex: Climatiseurs)" required>  
                                <select id="task-freq" required>  
                                    <option value="">Fréquence</option>  
                                    <option value="daily">Quotidien</option>  
                                    <option value="weekly">Hebdomadaire</option>  
                                    <option value="monthly">Mensuel</option>  
                                    <option value="bimonthly">Bimestriel (chaque 2 mois)</option>  
                                    <option value="trimonthly">Trimestriel (chaque 3 mois)</option>  
                                    <option value="quadmonthly">Quadrimestriel (chaque 4 mois)</option>  
                                    <option value="semiannual">Semestriel (chaque 6 mois)</option>  
                                    <option value="annual">Annuel</option>  
                                    <option value="biannual">Bi-annuel (chaque 2 ans)</option>  
                                </select>  
                                <select id="task-resp" required>  
                                    <option value="">Responsable</option>  
                                </select>  
                                <textarea id="task-checklist" placeholder="Checklist (séparée par virgules, ex: Vérifier filtres, Nettoyer)"></textarea>  
                                <button type="button" onclick="saveTask()">Sauvegarder</button>  
                            </form>  
                            <h4>Suggestions de Tâches (cliquez pour pré-remplir)</h4>  
                            <ul id="task-templates"></ul>  
                        </div>  
                        <div id="task-detail" style="display:none;">  
                            <h3 id="detail-title"></h3>  
                            <select id="year-select" onchange="loadAnnualPlanning()"></select>  
                            <label id="filter-due"><input type="checkbox" onchange="filterDueMonths(this.checked)"> Afficher seulement mois dus</label>  
                            <table id="annual-table">  
                                <thead><tr><th>Mois</th><th>Responsable</th><th>Commentaires</th><th>Validé ?</th><th>Statut</th></tr></thead>  
                                <tbody id="annual-body"></tbody>  
                            </table>  
                            <button onclick="saveAnnualPlanning()">Sauvegarder Planning</button>  
                            <button onclick="generateTasksFromPlanning()">Générer Tâches Automatiques</button>  
                            <button onclick="exportAnnualToPDF()">Exporter Planning Annuel en PDF</button>  
                        </div>  
                    </div>  
                `;  
            } else if (currentSection !== 'maintenance') {  
                main.innerHTML += `  
                    <div id="tasks" class="tab-content">  
                        <h2>Tâches à Suivre</h2>  
                        <form id="form-tasks">  
                            <input type="text" id="tache-tasks" placeholder="Description de la tâche" required>  
                            <select id="statut-tasks" required>  
                                <option value="">Statut</option>  
                                <option value="En cours">En cours</option>  
                                <option value="Terminée">Terminée</option>  
                                <option value="En attente">En attente</option>  
                            </select>  
                            <input type="date" id="date-tasks" placeholder="Date début" required>  
                            <input type="date" id="date-butoir-tasks" placeholder="Date butoir (optionnel)">  
                            <input type="text" id="responsable-tasks" placeholder="Nom du responsable (optionnel)">  
                            <select id="criticite-tasks" required>  
                                <option value="">Criticité (1-5)</option>  
                                <option value="1">1 (Très Critique)</option>  
                                <option value="2">2</option>  
                                <option value="3">3</option>  
                                <option value="4">4</option>  
                                <option value="5">5 (Faible)</option>  
                            </select>  
                            <textarea id="checklist-tasks" placeholder="Checklist (séparée par virgules)"></textarea>  
                            <button type="button" onclick="ajouterTache('tasks')">Ajouter Tâche</button>  
                        </form>  
                        <table id="table-tasks">  
                            <thead><tr><th>Tâche</th><th>Statut</th><th>Date Début</th><th>Date Butoir</th><th>Responsable</th><th>Criticité</th><th>Commentaires</th><th>Checklist</th><th>Actions</th></tr></thead>  
                            <tbody></tbody>  
                        </table>  
                        <button onclick="exporterDonnees('tasks')">Exporter en CSV</button>  
                    </div>  
                `;  
            } else {  
                maintenanceSites.forEach(site => {  
                    main.innerHTML += `  
                        <div id="${site}" class="tab-content">  
                            <h2>${site} - Suivi des Tâches</h2>  
                            <form id="form-${site}">  
                                <input type="text" id="tache-${site}" placeholder="Description de la tâche" required>  
                                <select id="statut-${site}" required>  
                                    <option value="">Statut</option>  
                                    <option value="En cours">En cours</option>  
                                    <option value="Terminée">Terminée</option>  
                                    <option value="En attente">En attente</option>  
                                </select>  
                                <input type="date" id="date-${site}" placeholder="Date début" required>  
                                <input type="date" id="date-butoir-${site}" placeholder="Date butoir (optionnel)">  
                                <input type="text" id="responsable-${site}" placeholder="Nom du responsable (optionnel)">  
                                <select id="criticite-${site}" required>  
                                    <option value="">Criticité (1-5)</option>  
                                    <option value="1">1 (Très Critique)</option>  
                                    <option value="2">2</option>  
                                    <option value="3">3</option>  
                                    <option value="4">4</option>  
                                    <option value="5">5 (Faible)</option>  
                                </select>  
                                <textarea id="checklist-${site}" placeholder="Checklist (séparée par virgules)"></textarea>  
                                <button type="button" onclick="ajouterTache('${site}')">Ajouter Tâche</button>  
                            </form>  
                            <table id="table-${site}">  
                                <thead><tr><th>Tâche</th><th>Statut</th><th>Date Début</th><th>Date Butoir</th><th>Responsable</th><th>Criticité</th><th>Commentaires</th><th>Checklist</th><th>Actions</th></tr></thead>  
                                <tbody></tbody>  
                            </table>  
                            <button onclick="exporterDonnees('${site}')">Exporter en CSV</button>  
                        </div>  
                    `;  
                });  
            }  
            loadButtonsForSection();  
            if (currentSection !== 'planning' && currentSection !== 'preventive') chargerTousDonnees();  
            if (currentSection === 'preventive') openTab('preventive-tab');  
            else openTab('dashboard');  
            checkAdminAndShowElements();  
        }  

        function loadButtonsForSection() {  
            const nav = document.getElementById('nav-bar');  
            nav.innerHTML = '';  
            const commonTabs = ['dashboard', 'userManagement', 'reports', 'completed-tasks']; // Sans audit-logs  
            commonTabs.forEach(tabId => {  
                const btn = document.createElement('button');  
                btn.textContent = tabId.charAt(0).toUpperCase() + tabId.slice(1).replace('-', ' ');  
                btn.onclick = () => openTab(tabId);  
                nav.appendChild(btn);  
            });  
            if (currentSection === 'planning') {  
                const btn = document.createElement('button');  
                btn.textContent = 'Planning';  
                btn.onclick = () => openTab('planning-tab');  
                nav.appendChild(btn);  
            } else if (currentSection === 'preventive') {  
                const btn = document.createElement('button');  
                btn.textContent = 'Maintenance Préventive';  
                btn.onclick = () => openTab('preventive-tab');  
                nav.appendChild(btn);  
            } else if (currentSection !== 'maintenance') {  
                const btn = document.createElement('button');  
                btn.textContent = 'Tâches à Suivre';  
                btn.onclick = () => {  
                    openTab('tasks');  
                    chargerDonnees('tasks');  
                };  
                nav.appendChild(btn);  
            } else {  
                maintenanceSites.forEach(site => {  
                    const btn = document.createElement('button');  
                    btn.textContent = site;  
                    btn.onclick = () => openTab(site);  
                    nav.appendChild(btn);  
                });  
            }  
        }  

        function openTab(tabId) {  
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));  
            const tab = document.getElementById(tabId);  
            if (tab) tab.classList.add('active');  
            if (tabId === 'userManagement') updateUsersTable();  
            if (maintenanceSites.includes(tabId) || tabId === 'tasks' || tabId === 'completed-tasks') chargerDonnees(tabId);  
            if (tabId === 'dashboard') updateDashboard();  
            if (tabId === 'planning-tab') loadPlanning();  
        }  

        function isAdmin() {  
            return currentUser && adminEmails.includes(currentUser.email);  
        }  

        function isAuthorized() {  
            return !!currentUser;  
        }  

        function ajouterUtilisateur() {  
            if (!isAdmin()) return alert('Seul l\'admin peut ajouter des utilisateurs.');  
            const newUserEmail = document.getElementById('newUserEmail').value;  
            if (!newUserEmail) return;  
            db.ref('authorizedUsers').push(newUserEmail);  
            alert('Utilisateur ajouté: ' + newUserEmail);  
            updateUsersTable();  
        }  

        function updateUsersTable() {  
            const tableBody = document.querySelector('#table-users tbody');  
            if (!tableBody) return;  
            tableBody.innerHTML = '';  
            db.ref('authorizedUsers').once('value', snapshot => {  
                snapshot.forEach(child => {  
                    const user = child.val();  
                    const row = tableBody.insertRow();  
                    row.insertCell(0).textContent = user;  
                    const actionsCell = row.insertCell(1);  
                    const removeBtn = document.createElement('button');  
                    removeBtn.textContent = 'Supprimer';  
                    removeBtn.onclick = () => {  
                        db.ref('authorizedUsers/' + child.key).remove().then(updateUsersTable);  
                    };  
                    actionsCell.appendChild(removeBtn);  
                });  
            });  
        }  

        function ajouterTache(siteId) {  
            if (!isAuthorized()) return alert('Connectez-vous pour ajouter des tâches.');  
            const tache = document.getElementById(`tache-${siteId}`).value;  
            const statut = document.getElementById(`statut-${siteId}`).value;  
            const date = document.getElementById(`date-${siteId}`).value;  
            const dateButoir = document.getElementById(`date-butoir-${siteId}`).value || '';  
            const responsable = document.getElementById(`responsable-${siteId}`).value || '';  
            const criticite = document.getElementById(`criticite-${siteId}`).value;  
            const checklistStr = document.getElementById(`checklist-${siteId}`).value;  
            const checklist = checklistStr ? checklistStr.split(',').map(item => ({ text: item.trim(), checked: false })) : [];  
            if (!tache || !statut || !date || !criticite) return alert('Veuillez remplir les champs obligatoires.');  
            const refPath = currentSection === 'maintenance' ? `${currentSection}/tasks/${siteId}` : `${currentSection}/tasks`;  
            db.ref(refPath).push({ tache, statut, date, dateButoir, responsable, criticite, comments: [], checklist, signature: '' });  
            const form = document.getElementById(`form-${siteId}`);  
            if (form) form.reset();  
            alert('Tâche ajoutée !');  
            openTab('dashboard');  
        }  

        function showEditForm(siteId, key, row, item, section) {  
            const tacheCell = row.cells[0];  
            const statutCell = row.cells[1];  
            const dateCell = row.cells[2];  
            const dateButoirCell = row.cells[3];  
            const respCell = row.cells[4];  
            const critCell = row.cells[5];  
            const commentsCell = row.cells[6];  
            const checklistCell = row.cells[7];  
            const actionsCell = row.cells[8];  

            tacheCell.innerHTML = `<input type="text" value="${item.tache}">`;  
            statutCell.innerHTML = `<select>  
                <option value="En cours" ${item.statut === 'En cours' ? 'selected' : ''}>En cours</option>  
                <option value="Terminée" ${item.statut === 'Terminée' ? 'selected' : ''}>Terminée</option>  
                <option value="En attente" ${item.statut === 'En attente' ? 'selected' : ''}>En attente</option>  
            </select>`;  
            dateCell.innerHTML = `<input type="date" value="${item.date}">`;  
            dateButoirCell.innerHTML = `<input type="date" value="${item.dateButoir || ''}">`;  
            respCell.innerHTML = `<input type="text" value="${item.responsable || ''}">`;  
            critCell.innerHTML = `<select>  
                <option value="1" ${item.criticite === '1' ? 'selected' : ''}>1</option>  
                <option value="2" ${item.criticite === '2' ? 'selected' : ''}>2</option>  
                <option value="3" ${item.criticite === '3' ? 'selected' : ''}>3</option>  
                <option value="4" ${item.criticite === '4' ? 'selected' : ''}>4</option>  
                <option value="5" ${item.criticite === '5' ? 'selected' : ''}>5</option>  
            </select>`;  
            commentsCell.innerHTML = 'Édition commentaires non disponible ici';  
            checklistCell.innerHTML = 'Édition checklist non disponible ici';  

            actionsCell.innerHTML = '';  
            const saveBtn = document.createElement('button');  
            saveBtn.textContent = 'Sauvegarder';  
            saveBtn.onclick = () => {  
                const newData = {  
                    tache: tacheCell.querySelector('input').value,  
                    statut: statutCell.querySelector('select').value,  
                    date: dateCell.querySelector('input').value,  
                    dateButoir: dateButoirCell.querySelector('input').value || '',  
                    responsable: respCell.querySelector('input').value || '',  
                    criticite: critCell.querySelector('select').value  
                };  
                const refPath = section === 'maintenance' ? `${section}/tasks/${siteId}/${key}` : `${section}/tasks/${key}`;  
                db.ref(refPath).update(newData);  
                if (newData.statut === 'Terminée') {  
                    db.ref(`${section}/completed-tasks`).push({...newData, completionDate: new Date().toISOString(), signature: `${currentUser.email} - ${new Date().toLocaleString()}`});  
                    db.ref(refPath).remove();  
                    alert('Tâche terminée et déplacée.');  
                } else {  
                    alert('Tâche mise à jour.');  
                }  
                if (currentSection !== 'planning') chargerDonnees(siteId);  
                updateDashboard();  
                if (currentSection === 'planning') loadPlanning();  
            };  
            actionsCell.appendChild(saveBtn);  
        }  

        function supprimerTache(siteId, key, item, section) {  
            if (!isAuthorized()) return alert('Non autorisé.');  
            const refPath = section === 'maintenance' ? `${section}/tasks/${siteId}/${key}` : `${section}/tasks/${key}`;  
            if (item.statut === 'Terminée') {  
                db.ref(`${section}/completed-tasks`).push(item);  
            }  
            db.ref(refPath).remove();  
            alert('Tâche supprimée.');  
            if (currentSection !== 'planning') chargerDonnees(siteId);  
            updateDashboard();  
            if (currentSection === 'planning') loadPlanning();  
        }  

        function chargerDonnees(tabId) {  
            let refPath = tabId === 'completed-tasks' ? `${currentSection}/completed-tasks` : (currentSection === 'maintenance' ? `${currentSection}/tasks/${tabId}` : `${currentSection}/tasks`);  
            const tableId = tabId === 'completed-tasks' ? 'table-completed' : `table-${tabId}`;  
            const tableBody = document.querySelector(`#${tableId} tbody`);  
            if (!tableBody) return;  
            db.ref(refPath).on('value', snapshot => {  
                tableBody.innerHTML = '';  
                if (!snapshot.exists()) {  
                    const row = tableBody.insertRow();  
                    const cell = row.insertCell(0);  
                    cell.colSpan = tabId === 'completed-tasks' ? 7 : 9;  
                    cell.classList.add('no-data');  
                    cell.textContent = 'Aucune tâche pour le moment.';  
                    return;  
                }  
                snapshot.forEach(child => {  
                    const item = child.val();  
                    item.responsable = item.responsable || 'Non assigné';  
                    item.criticite = item.criticite || 3;  
                    item.dateButoir = item.dateButoir || item.date;  
                    item.comments = item.comments || [];  
                    item.checklist = item.checklist || [];  
                    item.signature = item.signature || '';  
                    const row = tableBody.insertRow();  
                    row.insertCell(0).textContent = item.tache;  
                    row.insertCell(1).textContent = item.statut;  
                    row.insertCell(2).textContent = item.date;  
                    row.insertCell(3).textContent = item.dateButoir;  
                    row.insertCell(4).textContent = item.responsable;  
                    const critCell = row.insertCell(5);  
                    critCell.textContent = item.criticite;  
                    const critNum = parseInt(item.criticite);  
                    if (critNum === 1) critCell.classList.add('crit-high-red');  
                    else if (critNum === 2 || critNum === 3) critCell.classList.add('crit-medium-orange');  
                    else if (critNum === 4 || critNum === 5) critCell.classList.add('crit-low-green');  
                    const commentsCell = row.insertCell(6);  
                    commentsCell.textContent = item.comments.length + ' commentaires';  
                    commentsCell.onclick = () => showCommentsModal(child.key, item.comments, refPath + '/' + child.key);  
                    const checklistCell = row.insertCell(7);  
                    checklistCell.textContent = item.checklist.length + ' items';  
                    checklistCell.onclick = () => showChecklistModal(child.key, item.checklist, refPath + '/' + child.key);  
                    if (tabId === 'completed-tasks') {  
                        row.insertCell(8).textContent = item.signature;  
                    } else {  
                        const actionsCell = row.insertCell(8);  
                        const editBtn = document.createElement('button');  
                        editBtn.textContent = 'Modifier';  
                        editBtn.onclick = () => showEditForm(tabId, child.key, row, item, currentSection);  
                        actionsCell.appendChild(editBtn);  
                        const deleteBtn = document.createElement('button');  
                        deleteBtn.textContent = 'Supprimer';  
                        deleteBtn.onclick = () => supprimerTache(tabId, child.key, item, currentSection);  
                        actionsCell.appendChild(deleteBtn);  
                    }  
                });  
            });  
        }  

        function showCommentsModal(taskKey, comments, taskRef) {  
            const modal = prompt('Commentaires actuels: ' + comments.join(', ') + '\nAjoutez un commentaire:');  
            if (modal) {  
                comments.push(`${currentUser.email}: ${modal}`);  
                db.ref(taskRef).update({comments});  
            }  
        }  

        function showChecklistModal(taskKey, checklist, taskRef) {  
            const checklistStr = checklist.map(item => item.text + (item.checked ? ' (checked)' : '')).join(', ');  
            const update = prompt('Checklist: ' + checklistStr + '\nMettez à jour (ex: index à checker):');  
            if (update) {  
                const index = parseInt(update);  
                if (!isNaN(index) && index < checklist.length) {  
                    checklist[index].checked = true;  
                    db.ref(taskRef).update({checklist});  
                }  
            }  
        }  

        function chargerTousDonnees() {  
            if (currentSection === 'maintenance') {  
                maintenanceSites.forEach(site => chargerDonnees(site));  
            } else if (currentSection !== 'planning' && currentSection !== 'preventive') {  
                chargerDonnees('tasks');  
            }  
            chargerDonnees('completed-tasks');  
        }  

        function exporterDonnees(siteId) {  
            const refPath = currentSection === 'maintenance' ? `${currentSection}/tasks/${siteId}` : `${currentSection}/tasks`;  
            db.ref(refPath).once('value', snapshot => {  
                let csv = 'Tâche,Statut,Date Début,Date Butoir,Responsable,Criticité,Commentaires,Checklist\n';  
                snapshot.forEach(child => {  
                    const item = child.val();  
                    csv += `${item.tache},${item.statut},${item.date},${item.dateButoir || item.date},${item.responsable || 'Non assigné'},${item.criticite || 3},"${(item.comments || []).join('; ')}","${(item.checklist || []).map(c => c.text).join('; ')}"\n`;  
                });  
                const blob = new Blob([csv], { type: 'text/csv' });  
                const a = document.createElement('a');  
                a.href = URL.createObjectURL(blob);  
                a.download = `${siteId}_tasks.csv`;  
                a.click();  
            });  
        }  

        function exportPlanningToPDF() {  
            const { jsPDF } = window.jspdf;  
            const doc = new jsPDF();  
            doc.text('Planning Hebdomadaire', 10, 10);  
            const rows = document.querySelectorAll('#table-planning tbody tr');  
            let y = 20;  
            rows.forEach(row => {  
                const cells = row.querySelectorAll('td');  
                doc.text(`${cells[0].textContent} - ${cells[3].textContent} (${cells[2].textContent})`, 10, y);  
                y += 10;  
            });  
            doc.save('planning.pdf');  
        }  

        function exportPlanningToICal() {  
            const cal = ical();  
            const rows = document.querySelectorAll('#table-planning tbody tr');  
            rows.forEach(row => {  
                const cells = row.querySelectorAll('td');  
                cal.createEvent({  
                    start: new Date(cells[1].textContent),  
                    end: new Date(cells[3].textContent),  
                    summary: cells[0].textContent,  
                    description: `Criticité: ${cells[2].textContent}, Statut: ${cells[4].textContent}`  
                });  
            });  
            const blob = new Blob([cal.toString()], { type: 'text/calendar' });  
            const a = document.createElement('a');  
            a.href = URL.createObjectURL(blob);  
            a.download = 'planning.ics';  
            a.click();  
        }  

        function effacerToutesDonneesTerminees() {  
            if (!isAdmin()) return alert('Seul l\'admin peut effacer.');  
            if (confirm('Êtes-vous sûr ?')) {  
                db.ref(`${currentSection}/completed-tasks`).remove();  
                alert('Tâches terminées effacées.');  
            }  
        }  

        function updateDashboard() {  
            const canvas = document.getElementById('tasksChart');  
            if (!canvas) return;  
            let enCours = 0, terminees = 0, enAttente = 0, totalDays = 0, completedCount = 0, totalTasks = 0;  
            const refPath = `${currentSection}/tasks`;  
            db.ref(refPath).once('value', snapshot => {  
                if (!snapshot.exists()) {  
                    updateStats(0, 0, 0, 0, 0);  
                    return;  
                }  
                snapshot.forEach(site => {  
                    site.forEach(task => {  
                        const item = task.val();  
                        totalTasks++;  
                        if (item.statut === 'En cours') enCours++;  
                        else if (item.statut === 'Terminée') {  
                            terminees++;  
                            completedCount++;  
                            const start = new Date(item.date);  
                            const end = new Date(item.dateButoir || item.date);  
                            totalDays += (end - start) / (1000 * 60 * 60 * 24);  
                        } else if (item.statut === 'En attente') enAttente++;  
                    });  
                });  
                const avgTime = completedCount > 0 ? (totalDays / completedCount).toFixed(2) : 0;  
                const completionRate = totalTasks > 0 ? ((completedCount / totalTasks) * 100).toFixed(2) : 0;  
                updateStats(enCours, terminees, enAttente, avgTime, completionRate);  
                suggestPriorities();  
            });  
        }  

        function updateStats(enCours, terminees, enAttente, avgTime, completionRate) {  
            document.getElementById('en-cours').textContent = `Tâches en Cours : ${enCours}`;  
            document.getElementById('terminees').textContent = `Tâches Terminées : ${terminees}`;  
            document.getElementById('en-attente').textContent = `Tâches en Attente : ${enAttente}`;  
            document.getElementById('temps-moyen').textContent = `Temps Moyen de Résolution : ${avgTime} jours`;  
            document.getElementById('taux-completion').textContent = `Taux de Completion : ${completionRate}%`;  
            if (tasksChart) tasksChart.destroy();  
            const ctx = document.getElementById('tasksChart').getContext('2d');  
            tasksChart = new Chart(ctx, {  
                type: 'pie',  
                data: { labels: ['En cours', 'Terminées', 'En attente'], datasets: [{ data: [enCours, terminees, enAttente], backgroundColor: ['#ffc107', '#28a745', '#dc3545'], borderWidth: 1 }] },  
                options: { responsive: true }  
            });  
        }  

        function suggestPriorities() {  
            const suggestions = document.getElementById('priority-suggestions');  
            suggestions.innerHTML = '';  
            const today = new Date();  
            allSections.forEach(section => {  
                db.ref(`${section}/tasks`).once('value', snapshot => {  
                    snapshot.forEach(sub => {  
                        sub.forEach(taskSnap => {  
                            const task = taskSnap.val();  
                            const butoir = new Date(task.dateButoir || task.date);  
                            const daysLate = (today - butoir) / (1000 * 60 * 60 * 24);  
                            if (parseInt(task.criticite) === 1 && daysLate > 1) {  
                                const div = document.createElement('div');  
                                div.classList.add('priority-alert');  
                                div.textContent = `Priorité haute: ${task.tache} (retard ${daysLate.toFixed(0)} jours) - Sugérer réassignation?`;  
                                suggestions.appendChild(div);  
                            }  
                        });  
                    });  
                });  
            });  
        }  

        function generateReports() {  
            const refPath = `${currentSection}/tasks`;  
            db.ref(refPath).once('value', snapshot => {  
                const monthly = {};  
                const annual = {};  
                snapshot.forEach(siteSnap => {  
                    siteSnap.forEach(taskSnap => {  
                        const { date, statut } = taskSnap.val();  
                        if (!date) return;  
                        const taskDate = new Date(date);  
                        if (isNaN(taskDate)) return;  
                        const monthKey = `${taskDate.getFullYear()}-${taskDate.getMonth() + 1}`;  
                        const yearKey = taskDate.getFullYear();  
                        monthly[monthKey] = monthly[monthKey] || { added: 0, completed: 0 };  
                        annual[yearKey] = annual[yearKey] || { added: 0, completed: 0 };  
                        monthly[monthKey].added++;  
                        annual[yearKey].added++;  
                        if (statut === 'Terminée') {  
                            monthly[monthKey].completed++;  
                            annual[yearKey].completed++;  
                        }  
                    });  
                });  
                let monthlyText = '';  
                for (const [key, data] of Object.entries(monthly)) {  
                    monthlyText += `${key}: ${data.added} ajoutées, ${data.completed} terminées\n`;  
                }  
                let annualText = '';  
                for (const [key, data] of Object.entries(annual)) {  
                    annualText += `${key}: ${data.added} ajoutées, ${data.completed} terminées\n`;  
                }  
                document.getElementById('monthly-report').textContent = monthlyText || 'Aucune donnée mensuelle.';  
                document.getElementById('annual-report').textContent = annualText || 'Aucune donnée annuelle.';  
            });  
        }  

        function sendAutoReport() {  
            alert('Rapport automatique envoyé (simulation) - Téléchargement du rapport.');  
            generateReports();  
        }  

        // Fonctions pour Planning  
        let currentWeekStart = new Date();  
        currentWeekStart.setDate(currentWeekStart.getDate() - currentWeekStart.getDay() + 1); // Lundi  

        function loadPrestataires() {  
            const select = document.getElementById('prestataire-select');  
            if (select) {  
                db.ref('authorizedUsers').once('value', snapshot => {  
                    snapshot.forEach(child => {  
                        const email = child.val();  
                        const option = document.createElement('option');  
                        option.value = email;  
                        option.textContent = email;  
                        select.appendChild(option);  
                    });  
                });  
            }  
        }  

        function checkAdminAndShowElements() {  
            const isAdminUser = isAdmin();  
            document.querySelectorAll('.admin-only').forEach(el => {  
                el.style.display = isAdminUser ? 'block' : 'none';  
            });  
        }  

        function loadPlanning() {  
            const prestataire = document.getElementById('prestataire-select').value;  
            const tableBody = document.querySelector('#table-planning tbody');  
            if (!tableBody || !prestataire) return;  
            tableBody.innerHTML = '';  
            const weekEnd = new Date(currentWeekStart);  
            weekEnd.setDate(weekEnd.getDate() + 6);  
            document.getElementById('week-display').textContent = `Semaine du ${currentWeekStart.toLocaleDateString()} au ${weekEnd.toLocaleDateString()}`;  
            const today = new Date();  

            allSections.forEach(section => {  
                const basePath = `${section}/tasks`;  
                db.ref(basePath).once('value', snapshot => {  
                    snapshot.forEach(subSnap => {  
                        const subKey = subSnap.key;  
                        subSnap.forEach(taskSnap => {  
                            const task = taskSnap.val();  
                            const taskKey = taskSnap.key;  
                            if (task.responsable === prestataire && task.statut !== 'Terminée') {  
                                const taskDateDebut = new Date(task.date);  
                                const taskDateButoir = new Date(task.dateButoir || task.date);  
                                if ((taskDateDebut <= weekEnd && taskDateButoir >= currentWeekStart) || (taskDateDebut >= currentWeekStart && taskDateDebut <= weekEnd)) {  
                                    const row = tableBody.insertRow();  
                                    row.dataset.section = section;  
                                    row.dataset.subKey = subKey;  
                                    row.dataset.taskKey = taskKey;  
                                    row.insertCell(0).textContent = task.tache;  
                                    row.insertCell(1).textContent = task.date;  
                                    const critCell = row.insertCell(2);  
                                    critCell.textContent = task.criticite;  
                                    const critNum = parseInt(task.criticite);  
                                    if (critNum === 1) critCell.classList.add('crit-high-red');  
                                    else if (critNum === 2 || critNum === 3) critCell.classList.add('crit-medium-orange');  
                                    else if (critNum === 4 || critNum === 5) critCell.classList.add('crit-low-green');  
                                    const butoirCell = row.insertCell(3);  
                                    butoirCell.textContent = task.dateButoir || task.date;  
                                    if (taskDateButoir < today) butoirCell.classList.add('overdue');  
                                    row.insertCell(4).textContent = task.statut;  
                                    row.insertCell(5).textContent = section + (section === 'maintenance' ? ` (${subKey})` : '');  
                                    const commentsCell = row.insertCell(6);  
                                    commentsCell.textContent = (task.comments || []).length + ' commentaires';  
                                    commentsCell.onclick = () => showCommentsModal(taskKey, task.comments || [], basePath + '/' + subKey + '/' + taskKey);  
                                    const checklistCell = row.insertCell(7);  
                                    checklistCell.textContent = (task.checklist || []).length + ' items';  
                                    checklistCell.onclick = () => showChecklistModal(taskKey, task.checklist || [], basePath + '/' + subKey + '/' + taskKey);  
                                    if (isAdmin()) {  
                                        const actionsCell = row.insertCell(8);  
                                        const editBtn = document.createElement('button');  
                                        editBtn.textContent = 'Modifier';  
                                        editBtn.onclick = () => showEditForm(subKey, taskKey, row, task, section);  
                                        actionsCell.appendChild(editBtn);  
                                        const deleteBtn = document.createElement('button');  
                                        deleteBtn.textContent = 'Supprimer';  
                                        deleteBtn.onclick = () => supprimerTache(subKey, taskKey, task, section);  
                                        actionsCell.appendChild(deleteBtn);  
                                    }  
                                }  
                            }  
                        });  
                    });  
                    if (tableBody.rows.length === 0) {  
                        tableBody.innerHTML = '<tr><td colspan="9" class="no-data">Aucune tâche pour cette semaine.</td></tr>';  
                    }  
                });  
            });  
        }  

        function changeWeek(offset) {  
            currentWeekStart.setDate(currentWeekStart.getDate() + offset * 7);  
            loadPlanning();  
        }  

        function effacerPlanning() {  
            if (confirm('Êtes-vous sûr ?')) {  
                const rows = document.querySelectorAll('#table-planning tbody tr');  
                rows.forEach(row => {  
                    if (row.classList.contains('no-data')) return;  
                    const section = row.dataset.section;  
                    const subKey = row.dataset.subKey;  
                    const taskKey = row.dataset.taskKey;  
                    const refPath = section === 'maintenance' ? `${section}/tasks/${subKey}/${taskKey}` : `${section}/tasks/${taskKey}`;  
                    db.ref(refPath).remove();  
                });  
                alert('Contenu effacé.');  
                loadPlanning();  
            }  
        }  

        function creerNouveauPlanning() {  
            const formDiv = document.getElementById('new-planning-form');  
            if (formDiv) formDiv.style.display = 'block';  
            const responsableInput = document.getElementById('new-responsable');  
            const prestataireSelect = document.getElementById('prestataire-select');  
            if (responsableInput && prestataireSelect) {  
                responsableInput.value = prestataireSelect.value;  
            }  
        }  

        function ajouterTacheAuPlanning() {  
            const prestataire = document.getElementById('prestataire-select').value;  
            if (!prestataire) return alert('Sélectionnez un prestataire.');  
            const section = document.getElementById('new-section').value;  
            const site = section === 'maintenance' ? document.getElementById('new-site').value : '';  
            if (section === 'maintenance' && !site) return alert('Sélectionnez un site.');  
            const checklistStr = document.getElementById('new-checklist').value;  
            const checklist = checklistStr ? checklistStr.split(',').map(item => ({ text: item.trim(), checked: false })) : [];  
            const newData = {  
                tache: document.getElementById('new-tache').value,  
                statut: document.getElementById('new-statut').value,  
                date: document.getElementById('new-date-debut').value,  
                dateButoir: document.getElementById('new-date-butoir').value,  
                responsable: prestataire,  
                criticite: document.getElementById('new-criticite').value,  
                comments: [],  
                checklist  
            };  
            if (!newData.tache || !newData.statut || !newData.date || !newData.dateButoir || !newData.criticite) return alert('Remplissez tous les champs.');  
            const refPath = section === 'maintenance' ? `${section}/tasks/${site}` : `${section}/tasks`;  
            db.ref(refPath).push(newData);  
            document.getElementById('form-new-planning').reset();  
            document.getElementById('new-planning-form').style.display = 'none';  
            alert('Tâche ajoutée.');  
            loadPlanning();  
        }  

        // Fonctions pour Maintenance Préventive  
        let selectedDept = '';  
        let selectedTaskKey = '';  
        let selectedTask = null;  
        let selectedYear = new Date().getFullYear();  
        let isEditing = false;  
        let dueMonthsFilter = false;  

        function loadTaskDropdown(dept) {  
            selectedDept = dept;  
            const addBtn = document.getElementById('add-task-btn');  
            const listBtn = document.getElementById('list-task-btn');  
            const taskSelect = document.getElementById('task-select');  
            const detail = document.getElementById('task-detail');  
            if (addBtn) addBtn.style.display = dept ? 'inline-block' : 'none';  
            if (listBtn) listBtn.style.display = dept ? 'inline-block' : 'none';  
            if (taskSelect) taskSelect.style.display = dept ? 'inline-block' : 'none';  
            if (detail) detail.style.display = 'none';  
            if (!dept || !taskSelect) return;  
            taskSelect.innerHTML = '<option value="">Sélectionnez une tâche</option>';  
            db.ref(`preventive/tasks/${dept}`).once('value', snapshot => {  
                snapshot.forEach(child => {  
                    const item = child.val();  
                    const option = document.createElement('option');  
                    option.value = child.key;  
                    option.textContent = `${item.tache} (${item.frequence})`;  
                    taskSelect.appendChild(option);  
                });  
            });  
        }  

        function showTaskListModal() {  
            const modal = document.getElementById('task-list-modal');  
            const content = document.getElementById('task-list-content');  
            if (!modal || !content) return;  
            content.innerHTML = '';  
            db.ref(`preventive/tasks/${selectedDept}`).once('value', snapshot => {  
                if (!snapshot.exists()) {  
                    content.innerHTML = '<p class="no-data">Aucune tâche préventive.</p>';  
                } else {  
                    snapshot.forEach(child => {  
                        const item = child.val();  
                        const div = document.createElement('div');  
                        div.classList.add('task-item');  
                        const textSpan = document.createElement('span');  
                        textSpan.textContent = `${item.tache} (${item.frequence})`;  
                        textSpan.onclick = () => {  
                            closeTaskListModal();  
                            document.getElementById('task-select').value = child.key;  
                            loadTaskDetail(child.key);  
                        };  
                        div.appendChild(textSpan);  
                        const editBtn = document.createElement('button');  
                        editBtn.textContent = 'Modifier';  
                        editBtn.onclick = () => {  
                            closeTaskListModal();  
                            showAddTaskForm(child.key, item);  
                        };  
                        div.appendChild(editBtn);  
                        content.appendChild(div);  
                    });  
                }  
            });  
            modal.style.display = 'block';  
        }  

        function closeTaskListModal() {  
            document.getElementById('task-list-modal').style.display = 'none';  
        }  

        function loadTaskDetail(key) {  
            if (!key) return;  
            db.ref(`preventive/tasks/${selectedDept}/${key}`).once('value', snapshot => {  
                selectedTaskKey = key;  
                selectedTask = snapshot.val();  
                const detail = document.getElementById('task-detail');  
                const title = document.getElementById('detail-title');  
                if (detail) detail.style.display = 'block';  
                if (title) title.textContent = `${selectedTask.tache} - Fréquence: ${selectedTask.frequence} - Responsable par défaut: ${selectedTask.responsable}`;  
                loadYearSelect();  
                loadAnnualPlanning();  
            });  
        }  

        function showAddTaskForm(key = null, task = null) {  
            const form = document.getElementById('add-task-form');  
            const title = document.getElementById('add-task-title');  
            if (form) form.style.display = 'block';  
            if (title) title.textContent = key ? 'Modifier Tâche Préventive' : 'Ajouter Tâche Préventive';  
            isEditing = !!key;  
            selectedTaskKey = key;  
            document.getElementById('task-name').value = task ? task.tache : '';  
            document.getElementById('task-freq').value = task ? task.frequence : '';  
            document.getElementById('task-resp').value = task ? task.responsable : '';  
            document.getElementById('task-checklist').value = task ? task.checklist.map(i => i.text).join(', ') : '';  
            loadTaskTemplates(selectedDept);  
            loadPrestatairesForPreventive('task-resp');  
        }  

        function loadTaskTemplates(dept) {  
            const list = document.getElementById('task-templates');  
            if (!list) return;  
            list.innerHTML = '';  
            preventiveTemplates[dept].forEach(template => {  
                const li = document.createElement('li');  
                li.textContent = template;  
                li.style.cursor = 'pointer';  
                li.onclick = () => {  
                    document.getElementById('task-name').value = template;  
                    document.getElementById('task-checklist').value = checklistSuggestions[template] || '';  
                };  
                list.appendChild(li);  
            });  
        }  

        function loadPrestatairesForPreventive(selectId) {  
            const select = document.getElementById(selectId);  
            if (!select) return;  
            db.ref('authorizedUsers').once('value', snapshot => {  
                select.innerHTML = '<option value="">Responsable</option>';  
                snapshot.forEach(child => {  
                    const email = child.val();  
                    const option = document.createElement('option');  
                    option.value = email;  
                    option.textContent = email;  
                    select.appendChild(option);  
                });  
            });  
        }  

        function saveTask() {  
            const tache = document.getElementById('task-name').value;  
            const frequence = document.getElementById('task-freq').value;  
            const responsable = document.getElementById('task-resp').value;  
            const checklistStr = document.getElementById('task-checklist').value;  
            const checklist = checklistStr ? checklistStr.split(',').map(d => ({ text: d.trim(), checked: false })) : [];  
            if (!tache || !frequence || !responsable) return alert('Remplissez tous les champs.');  
            const data = { tache, frequence, responsable, checklist };  
            const ref = db.ref(`preventive/tasks/${selectedDept}`);  
            if (isEditing) {  
                ref.child(selectedTaskKey).update(data);  
                alert('Tâche modifiée !');  
            } else {  
                ref.push(data);  
                alert('Tâche ajoutée !');  
            }  
            document.getElementById('add-task-form').style.display = 'none';  
            loadTaskDropdown(selectedDept);  
        }  

        function loadYearSelect() {  
            const select = document.getElementById('year-select');  
            if (!select) return;  
            select.innerHTML = '';  
            const currentYear = new Date().getFullYear();  
            for (let y = currentYear - 5; y <= 2030; y++) {  
                const option = document.createElement('option');  
                option.value = y;  
                option.textContent = y;  
                if (y === selectedYear) option.selected = true;  
                select.appendChild(option);  
            }  
        }  

        function loadAnnualPlanning() {  
            selectedYear = parseInt(document.getElementById('year-select').value);  
            const body = document.getElementById('annual-body');  
            if (!body) return;  
            body.innerHTML = '';  
            db.ref(`preventive/tasks/${selectedDept}/${selectedTaskKey}/annualPlans/${selectedYear}`).once('value', snapshot => {  
                let planning = snapshot.val() || months.map(() => ({ responsible: selectedTask.responsable, comments: '', validated: false, statut: 'En attente' }));  
                const dueMonths = calculateDueMonths(new Date(), selectedTask.frequence, selectedYear); // Date actuelle comme fallback  
                months.forEach((month, index) => {  
                    if (dueMonthsFilter && !dueMonths.includes(index)) return;  
                    const row = body.insertRow();  
                    row.dataset.monthIndex = index;  
                    const monthCell = row.insertCell(0);  
                    monthCell.textContent = month;  
                    if (dueMonths.includes(index)) monthCell.classList.add('due-month');  
                    const respCell = row.insertCell(1);  
                    const respSelect = document.createElement('select');  
                    db.ref('authorizedUsers').once('value', snap => {  
                        snap.forEach(child => {  
                            const email = child.val();  
                            const option = document.createElement('option');  
                            option.value = email;  
                            option.textContent = email;  
                            if (email === planning[index].responsible) option.selected = true;  
                            respSelect.appendChild(option);  
                        });  
                    });  
                    respCell.appendChild(respSelect);  
                    const commentsCell = row.insertCell(2);  
                    commentsCell.innerHTML = `<input type="text" value="${planning[index].comments || ''}">`;  
                    const checkboxCell = row.insertCell(3);  
                    const checkbox = document.createElement('input');  
                    checkbox.type = 'checkbox';  
                    checkbox.checked = planning[index].validated;  
                    checkbox.onchange = () => {  
                        if (checkbox.checked && confirm('Valider ce mois ? Cela mettra le statut à Terminé.')) {  
                            planning[index].validated = true;  
                            planning[index].statut = 'Terminé';  
                            // Marquer checklist comme checked si elle existe  
                            if (selectedTask.checklist) selectedTask.checklist.forEach(item => item.checked = true);  
                            // Update status select  
                            const statusSelect = row.cells[4].querySelector('select');  
                            statusSelect.value = 'Terminé';  
                            statusSelect.disabled = true;  
                            checkbox.disabled = true;  
                        } else {  
                            checkbox.checked = false;  
                        }  
                    };  
                    checkboxCell.appendChild(checkbox);  
                    const statutCell = row.insertCell(4);  
                    const statutSelect = document.createElement('select');  
                    ['En attente', 'En cours', 'Terminé'].forEach(stat => {  
                        const opt = document.createElement('option');  
                        opt.value = stat;  
                        opt.textContent = stat;  
                        if (stat === planning[index].statut) opt.selected = true;  
                        statutSelect.appendChild(opt);  
                    });  
                    if (planning[index].statut === 'Terminé') statutSelect.disabled = true;  
                    statutCell.appendChild(statutSelect);  
                });  
            });  
        }  

        function filterDueMonths(checked) {  
            dueMonthsFilter = checked;  
            loadAnnualPlanning();  
        }  

        function calculateDueMonths(startDate, frequence, year) {  
            const due = [];  
            const freqMap = {  
                daily: 1 / 30, weekly: 1 / 4, monthly: 1, bimonthly: 2, trimonthly: 3, quadmonthly: 4,   
                semiannual: 6, annual: 12, biannual: 24  
            };  
            const interval = freqMap[frequence] || 1;  
            let current = new Date(startDate);  
            while (current.getFullYear() < year) {  
                current.setMonth(current.getMonth() + interval);  
            }  
            while (current.getFullYear() === year) {  
                due.push(current.getMonth());  
                current.setMonth(current.getMonth() + interval);  
                if (current.getFullYear() > year) break;  
            }  
            return due;  
        }  

        function saveAnnualPlanning() {  
            const body = document.getElementById('annual-body');  
            if (!body) return;  
            const planning = [];  
            Array.from(body.rows).forEach(row => {  
                const index = parseInt(row.dataset.monthIndex);  
                planning[index] = {  
                    responsible: row.cells[1].querySelector('select').value,  
                    comments: row.cells[2].querySelector('input').value,  
                    validated: row.cells[3].querySelector('input').checked,  
                    statut: row.cells[4].querySelector('select').value  
                };  
            });  
            db.ref(`preventive/tasks/${selectedDept}/${selectedTaskKey}/annualPlans/${selectedYear}`).set(planning);  
            alert('Planning annuel sauvegardé !');  
        }  

        function generateTasksFromPlanning() {  
            db.ref(`preventive/tasks/${selectedDept}/${selectedTaskKey}/annualPlans/${selectedYear}`).once('value', snapshot => {  
                const planning = snapshot.val() || [];  
                const dueMonths = calculateDueMonths(new Date(), selectedTask.frequence, selectedYear);  
                const refPath = selectedDept === 'maintenance' ? `${selectedDept}/tasks/CMDG` : `${selectedDept}/tasks`; // Default site for maintenance  
                dueMonths.forEach(monthIndex => {  
                    const monthData = planning[monthIndex] || { statut: 'En attente', responsible: selectedTask.responsable, comments: '' };  
                    if (monthData.statut === 'Terminé') return; // Skip si Terminé  
                    const nextDate = new Date(selectedYear, monthIndex, 1).toISOString().split('T')[0]; // Premier du mois  
                    db.ref(refPath).push({  
                        tache: `${selectedTask.tache} (Préventive) - ${months[monthIndex]}`,  
                        statut: monthData.statut,  
                        date: nextDate,  
                        dateButoir: nextDate,  
                        responsable: monthData.responsable,  
                        criticite: '3',  
                        comments: [monthData.comments],  
                        checklist: selectedTask.checklist ? JSON.parse(JSON.stringify(selectedTask.checklist)) : []  
                    });  
                });  
                alert('Tâches générées pour les mois dus (non terminés) !');  
            });  
        }  

        function exportAnnualToPDF() {  
            const { jsPDF } = window.jspdf;  
            const doc = new jsPDF();  
            doc.text(`${selectedTask.tache} - Planning Annuel ${selectedYear}`, 10, 10);  
            let y = 20;  
            const rows = document.querySelectorAll('#annual-body tr');  
            rows.forEach(row => {  
                const cells = row.querySelectorAll('td');  
                const isDue = row.querySelector('.due-month') ? ' (Due)' : '';  
                doc.text(`${cells[0].textContent}${isDue} - Responsable: ${cells[1].querySelector('select').value} - Commentaires: ${cells[2].querySelector('input').value} - Validé: ${cells[3].querySelector('input').checked ? 'Oui' : 'Non'} - Statut: ${cells[4].querySelector('select').value}`, 10, y);  
                y += 10;  
            });  
            doc.save(`${selectedTask.tache}_annual_${selectedYear}.pdf`);  
        }  

        //

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance CMDK (Version Locale)</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; display: flex; flex-direction: column; min-height: 100vh; }
        header { background-color: #007bff; color: white; padding: 10px; text-align: center; }
        nav { background-color: #e9ecef; padding: 10px; display: flex; justify-content: center; flex-wrap: wrap; }
        nav button { margin: 5px; padding: 10px 15px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; }
        nav button:hover { background-color: #218838; }
        main { flex: 1; padding: 20px; max-width: 100%; overflow-x: auto; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #007bff; color: white; }
        form { margin-bottom: 20px; }
        input, select { width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box; }
        button { padding: 10px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        #completed-tasks { margin-top: 20px; }
        footer { background-color: #007bff; color: white; text-align: center; padding: 10px; }
        #error-message { color: red; }
        #tasksChart { max-width: 400px; margin: 20px auto; }
        @media (max-width: 600px) { nav { flex-direction: column; } }
    </style>
    <!-- Chart.js pour diagrammes -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header>
        <h1>Maintenance CMDK</h1>
        <h2>Suivi des tâches de la maintenance CMDK (Version Locale)</h2>
    </header>
    
    <nav>
        <button onclick="openTab('dashboard')">Tableau de Bord</button>
        <button onclick="openTab('CMDG')">CMDG</button>
        <button onclick="openTab('CMDN')">CMDN</button>
        <button onclick="openTab('CMDLT')">CMDLT</button>
        <button onclick="openTab('CMDB')">CMDB</button>
        <button onclick="openTab('Manhattan')">Manhattan</button>
        <button onclick="openTab('Residence')">Residence</button>
        <button onclick="openTab('reports')">Rapports</button>
        <button onclick="openTab('completed-tasks')">Tâches Terminées</button>
    </nav>
    
    <main>
        <!-- Dashboard -->
        <div id="dashboard" class="tab-content active">
            <h2>Tableau de Bord</h2>
            <div class="stats">
                <div class="stat" id="en-cours">Tâches en Cours : 0</div>
                <div class="stat" id="terminees">Tâches Terminées : 0</div>
                <div class="stat" id="en-attente">Tâches en Attente : 0</div>
            </div>
            <canvas id="tasksChart"></canvas>
        </div>

        <!-- CMDG -->
        <div id="CMDG" class="tab-content">
            <h2>CMDG - Suivi des Tâches</h2>
            <form id="form-CMDG">
                <input type="text" id="tache-CMDG" placeholder="Description de la tâche" required>
                <select id="statut-CMDG" required>
                    <option value="">Statut</option>
                    <option value="En cours">En cours</option>
                    <option value="Terminée">Terminée</option>
                    <option value="En attente">En attente</option>
                </select>
                <input type="date" id="date-CMDG" required>
                <button type="button" onclick="ajouterTache('CMDG')">Ajouter Tâche</button>
            </form>
            <table id="table-CMDG">
                <thead><tr><th>Tâche</th><th>Statut</th><th>Date</th><th>Actions</th></tr></thead>
                <tbody></tbody>
            </table>
            <button onclick="exporterDonnees('CMDG')">Exporter en CSV</button>
            <button type="button" onclick="effacerDonnees('CMDG')">Effacer Toutes les Données</button>
        </div>

        <!-- CMDN -->
        <div id="CMDN" class="tab-content">
            <h2>CMDN - Suivi des Tâches</h2>
            <form id="form-CMDN">
                <input type="text" id="tache-CMDN" placeholder="Description de la tâche" required>
                <select id="statut-CMDN" required>
                    <option value="">Statut</option>
                    <option value="En cours">En cours</option>
                    <option value="Terminée">Terminée</option>
                    <option value="En attente">En attente</option>
                </select>
                <input type="date" id="date-CMDN" required>
                <button type="button" onclick="ajouterTache('CMDN')">Ajouter Tâche</button>
            </form>
            <table id="table-CMDN">
                <thead><tr><th>Tâche</th><th>Statut</th><th>Date</th><th>Actions</th></tr></thead>
                <tbody></tbody>
            </table>
            <button onclick="exporterDonnees('CMDN')">Exporter en CSV</button>
            <button type="button" onclick="effacerDonnees('CMDN')">Effacer Toutes les Données</button>
        </div>

        <!-- CMDLT -->
        <div id="CMDLT" class="tab-content">
            <h2>CMDLT - Suivi des Tâches</h2>
            <form id="form-CMDLT">
                <input type="text" id="tache-CMDLT" placeholder="Description de la tâche" required>
                <select id="statut-CMDLT" required>
                    <option value="">Statut</option>
                    <option value="En cours">En cours</option>
                    <option value="Terminée">Terminée</option>
                    <option value="En attente">En attente</option>
                </select>
                <input type="date" id="date-CMDLT" required>
                <button type="button" onclick="ajouterTache('CMDLT')">Ajouter Tâche</button>
            </form>
            <table id="table-CMDLT">
                <thead><tr><th>Tâche</th><th>Statut</th><th>Date</th><th>Actions</th></tr></thead>
                <tbody></tbody>
            </table>
            <button onclick="exporterDonnees('CMDLT')">Exporter en CSV</button>
            <button type="button" onclick="effacerDonnees('CMDLT')">Effacer Toutes les Données</button>
        </div>

        <!-- CMDB -->
        <div id="CMDB" class="tab-content">
            <h2>CMDB - Suivi des Tâches</h2>
            <form id="form-CMDB">
                <input type="text" id="tache-CMDB" placeholder="Description de la tâche" required>
                <select id="statut-CMDB" required>
                    <option value="">Statut</option>
                    <option value="En cours">En cours</option>
                    <option value="Terminée">Terminée</option>
                    <option value="En attente">En attente</option>
                </select>
                <input type="date" id="date-CMDB" required>
                <button type="button" onclick="ajouterTache('CMDB')">Ajouter Tâche</button>
            </form>
            <table id="table-CMDB">
                <thead><tr><th>Tâche</th><th>Statut</th><th>Date</th><th>Actions</th></tr></thead>
                <tbody></tbody>
            </table>
            <button onclick="exporterDonnees('CMDB')">Exporter en CSV</button>
            <button type="button" onclick="effacerDonnees('CMDB')">Effacer Toutes les Données</button>
        </div>

        <!-- Manhattan -->
        <div id="Manhattan" class="tab-content">
            <h2>Manhattan - Suivi des Tâches</h2>
            <form id="form-Manhattan">
                <input type="text" id="tache-Manhattan" placeholder="Description de la tâche" required>
                <select id="statut-Manhattan" required>
                    <option value="">Statut</option>
                    <option value="En cours">En cours</option>
                    <option value="Terminée">Terminée</option>
                    <option value="En attente">En attente</option>
                </select>
                <input type="date" id="date-Manhattan" required>
                <button type="button" onclick="ajouterTache('Manhattan')">Ajouter Tâche</button>
            </form>
            <table id="table-Manhattan">
                <thead><tr><th>Tâche</th><th>Statut</th><th>Date</th><th>Actions</th></tr></thead>
                <tbody></tbody>
            </table>
            <button onclick="exporterDonnees('Manhattan')">Exporter en CSV</button>
            <button type="button" onclick="effacerDonnees('Manhattan')">Effacer Toutes les Données</button>
        </div>

        <!-- Residence -->
        <div id="Residence" class="tab-content">
            <h2>Residence - Suivi des Tâches</h2>
            <form id="form-Residence">
                <input type="text" id="tache-Residence" placeholder="Description de la tâche" required>
                <select id="statut-Residence" required>
                    <option value="">Statut</option>
                    <option value="En cours">En cours</option>
                    <option value="Terminée">Terminée</option>
                    <option value="En attente">En attente</option>
                </select>
                <input type="date" id="date-Residence" required>
                <button type="button" onclick="ajouterTache('Residence')">Ajouter Tâche</button>
            </form>
            <table id="table-Residence">
                <thead><tr><th>Tâche</th><th>Statut</th><th>Date</th><th>Actions</th></tr></thead>
                <tbody></tbody>
            </table>
            <button onclick="exporterDonnees('Residence')">Exporter en CSV</button>
            <button type="button" onclick="effacerDonnees('Residence')">Effacer Toutes les Données</button>
        </div>

        <!-- Completed Tasks -->
        <div id="completed-tasks" class="tab-content">
            <h2>Tâches Terminées</h2>
            <table id="table-completed">
                <thead><tr><th>Tâche</th><th>Site</th><th>Date</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Reports -->
        <div id="reports" class="tab-content">
            <h2>Rapports</h2>
            <button onclick="generateReports()">Générer Rapports</button>
            <h3>Rapport Mensuel</h3>
            <pre id="monthly-report"></pre>
            <h3>Rapport Annuel</h3>
            <pre id="annual-report"></pre>
        </div>
    </main>
    
    <footer>
        <p>Application créée par Grok - xAI. Données stockées localement (pas de partage).</p>
    </footer>
    
    <script>
        const sites = ['CMDG', 'CMDN', 'CMDLT', 'CMDB', 'Manhattan', 'Residence'];
        let tasksChart = null;

        function openTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            const tab = document.getElementById(tabId);
            if (tab) tab.classList.add('active');
            if (sites.includes(tabId) || tabId === 'completed-tasks') chargerDonnees(tabId);
            updateDashboard();
        }

        function ajouterTache(siteId) {
            const tache = document.getElementById(`tache-${siteId}`).value;
            const statut = document.getElementById(`statut-${siteId}`).value;
            const date = document.getElementById(`date-${siteId}`).value;
            if (!tache || !statut || !date) return alert('Veuillez remplir tous les champs.');
            let tasks = JSON.parse(localStorage.getItem(`tasks-${siteId}`)) || [];
            tasks.push({ tache, statut, date });
            localStorage.setItem(`tasks-${siteId}`, JSON.stringify(tasks));
            document.getElementById(`form-${siteId}`).reset();
            alert('Tâche ajoutée !');
            openTab('dashboard'); // Redirection
            chargerDonnees(siteId);
            updateDashboard();
        }

        function showStatusSelect(siteId, index, statutCell, currentStatut, tache, date) {
            const select = document.createElement('select');
            ['En cours', 'Terminée', 'En attente'].forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                option.selected = opt === currentStatut;
                select.appendChild(option);
            });
            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'Sauvegarder';
            saveBtn.onclick = () => {
                const newStatut = select.value;
                if (newStatut !== currentStatut) {
                    let tasks = JSON.parse(localStorage.getItem(`tasks-${siteId}`)) || [];
                    tasks[index].statut = newStatut;
                    localStorage.setItem(`tasks-${siteId}`, JSON.stringify(tasks));
                    if (newStatut === 'Terminée') {
                        let completed = JSON.parse(localStorage.getItem('completed-tasks')) || [];
                        completed.push({ tache, site: siteId, date });
                        localStorage.setItem('completed-tasks', JSON.stringify(completed));
                        tasks.splice(index, 1);
                        localStorage.setItem(`tasks-${siteId}`, JSON.stringify(tasks));
                        alert('Tâche mise à "Terminée" et déplacée.');
                    } else {
                        alert('Statut mis à jour.');
                    }
                    chargerDonnees(siteId);
                    updateDashboard();
                }
                statutCell.innerHTML = newStatut;
            };
            statutCell.innerHTML = '';
            statutCell.appendChild(select);
            statutCell.appendChild(saveBtn);
        }

        function supprimerTache(siteId, index, statut, tache, date) {
            let tasks = JSON.parse(localStorage.getItem(`tasks-${siteId}`)) || [];
            if (statut === 'Terminée') {
                let completed = JSON.parse(localStorage.getItem('completed-tasks')) || [];
                completed.push({ tache, site: siteId, date });
                localStorage.setItem('completed-tasks', JSON.stringify(completed));
            }
            tasks.splice(index, 1);
            localStorage.setItem(`tasks-${siteId}`, JSON.stringify(tasks));
            alert('Tâche supprimée ou déplacée.');
            chargerDonnees(siteId);
            updateDashboard();
        }

        function chargerDonnees(tabId) {
            const isCompleted = tabId === 'completed-tasks';
            const key = isCompleted ? 'completed-tasks' : `tasks-${tabId}`;
            const tableBody = document.querySelector(isCompleted ? '#table-completed tbody' : `#table-${tabId} tbody`);
            if (!tableBody) return;
            tableBody.innerHTML = '';
            const data = JSON.parse(localStorage.getItem(key)) || [];
            data.forEach((item, index) => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = item.tache;
                if (isCompleted) {
                    row.insertCell(1).textContent = item.site;
                    row.insertCell(2).textContent = item.date;
                } else {
                    const statutCell = row.insertCell(1);
                    statutCell.textContent = item.statut;
                    row.insertCell(2).textContent = item.date;
                    const actionsCell = row.insertCell(3);
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Modifier Statut';
                    editBtn.onclick = () => showStatusSelect(tabId, index, statutCell, item.statut, item.tache, item.date);
                    actionsCell.appendChild(editBtn);
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Supprimer';
                    deleteBtn.onclick = () => supprimerTache(tabId, index, item.statut, item.tache, item.date);
                    actionsCell.appendChild(deleteBtn);
                }
            });
        }

        function exporterDonnees(siteId) {
            const tasks = JSON.parse(localStorage.getItem(`tasks-${siteId}`)) || [];
            let csv = 'Tâche,Statut,Date\n';
            tasks.forEach(item => {
                csv += `${item.tache},${item.statut},${item.date}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${siteId}_tasks.csv`;
            a.click();
        }

        function effacerDonnees(siteId) {
            if (confirm('Êtes-vous sûr ?')) {
                localStorage.removeItem(`tasks-${siteId}`);
                chargerDonnees(siteId);
                updateDashboard();
            }
        }

        function updateDashboard() {
            let enCours = 0, terminees = 0, enAttente = 0;
            sites.forEach(site => {
                const tasks = JSON.parse(localStorage.getItem(`tasks-${site}`)) || [];
                tasks.forEach(task => {
                    if (task.statut === 'En cours') enCours++;
                    else if (task.statut === 'Terminée') terminees++;
                    else if (task.statut === 'En attente') enAttente++;
                });
            });
            document.getElementById('en-cours').textContent = `Tâches en Cours : ${enCours}`;
            document.getElementById('terminees').textContent = `Tâches Terminées : ${terminees}`;
            document.getElementById('en-attente').textContent = `Tâches en Attente : ${enAttente}`;

            const canvas = document.getElementById('tasksChart');
            if (canvas) {
                if (tasksChart) tasksChart.destroy();
                const ctx = canvas.getContext('2d');
                tasksChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['En cours', 'Terminées', 'En attente'],
                        datasets: [{
                            data: [enCours, terminees, enAttente],
                            backgroundColor: ['#ffc107', '#28a745', '#dc3545'],
                            borderColor: ['#fff', '#fff', '#fff'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' },
                            title: { display: true, text: 'Répartition des Tâches' }
                        }
                    }
                });
            }
        }

        function generateReports() {
            const monthly = {};
            const annual = {};
            sites.forEach(site => {
                const tasks = JSON.parse(localStorage.getItem(`tasks-${site}`)) || [];
                tasks.forEach(task => {
                    if (!task.date) return;
                    const taskDate = new Date(task.date);
                    if (isNaN(taskDate)) return;
                    const monthKey = `${taskDate.getFullYear()}-${taskDate.getMonth() + 1}`;
                    const yearKey = taskDate.getFullYear().toString();
                    monthly[monthKey] = monthly[monthKey] || { added: 0, completed: 0, sites: {} };
                    annual[yearKey] = annual[yearKey] || { added: 0, completed: 0, sites: {} };
                    monthly[monthKey].added++;
                    annual[yearKey].added++;
                    monthly[monthKey].sites[site] = (monthly[monthKey].sites[site] || 0) + 1;
                    annual[yearKey].sites[site] = (annual[yearKey].sites[site] || 0) + 1;
                    if (task.statut === 'Terminée') {
                        monthly[monthKey].completed++;
                        annual[yearKey].completed++;
                    }
                });
            });

            let monthlyText = '';
            Object.entries(monthly).forEach(([key, data]) => {
                monthlyText += `${key}: ${data.added} ajoutées, ${data.completed} terminées (Détails par site: ${JSON.stringify(data.sites)})\n`;
            });

            let annualText = '';
            Object.entries(annual).forEach(([key, data]) => {
                annualText += `${key}: ${data.added} ajoutées, ${data.completed} terminées (Détails par site: ${JSON.stringify(data.sites)})\n`;
            });

            document.getElementById('monthly-report').textContent = monthlyText || 'Aucun données mensuelles.';
            document.getElementById('annual-report').textContent = annualText || 'Aucun données annuelles.';
        }

        // Initialisation
        sites.forEach(site => chargerDonnees(site));
        chargerDonnees('completed-tasks');
        updateDashboard();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance CMDK</title>
    <style>
        /* Ton CSS original, inchangé pour brevité */
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; display: flex; flex-direction: column; min-height: 100vh; }
        header { background-color: #007bff; color: white; padding: 10px; text-align: center; }
        nav { background-color: #e9ecef; padding: 10px; display: flex; justify-content: center; flex-wrap: wrap; }
        nav button { margin: 5px; padding: 10px 15px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; }
        nav button:hover { background-color: #218838; }
        main { flex: 1; padding: 20px; max-width: 100%; overflow-x: auto; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #007bff; color: white; }
        form { margin-bottom: 20px; }
        input, select { width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box; }
        button { padding: 10px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        #completed-tasks { margin-top: 20px; }
        footer { background-color: #007bff; color: white; text-align: center; padding: 10px; }
        @media (max-width: 600px) { nav { flex-direction: column; } }
    </style>
    <!-- Intégration Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js"></script>
</head>
<body>
    <header>
        <h1>Maintenance CMDK</h1>
        <h2>Suivi des tâches de la maintenance CMDK</h2>
    </header>
    
    <nav>
        <button onclick="openTab('dashboard')">Tableau de Bord</button>
        <button onclick="openTab('userManagement')">Gestion des Utilisateurs</button>
        <button onclick="openTab('CMDG')">CMDG</button>
        <button onclick="openTab('CMDN')">CMDN</button>
        <button onclick="openTab('CMDLT')">CMDLT</button>
        <button onclick="openTab('CMDB')">CMDB</button>
        <button onclick="openTab('Manhattan')">Manhattan</button>
        <button onclick="openTab('Residence')">Residence</button>
        <button onclick="openTab('reports')">Rapports</button> <!-- Corrigé pour openTab -->
        <button onclick="logout()">Déconnexion</button> <!-- Bouton de déconnexion -->
    </nav>
    
    <main>
        <!-- Ajout d'une section de login (visible au démarrage) -->
        <div id="login" class="tab-content active">
            <h2>Connexion</h2>
            <form id="form-login">
                <input type="email" id="email" placeholder="Email" required>
                <input type="password" id="password" placeholder="Mot de passe" required>
                <button type="button" onclick="login()">Se connecter</button>
                <button type="button" onclick="register()">S'inscrire</button>
            </form>
            <p id="login-message"></p>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="tab-content">
            <h2>Tableau de Bord</h2>
            <div class="stats">
                <div class="stat" id="en-cours">Tâches en Cours : 0</div>
                <div class="stat" id="terminees">Tâches Terminées : 0</div>
                <div class="stat" id="en-attente">Tâches en Attente : 0</div>
            </div>
        </div>

        <!-- User Management -->
        <div id="userManagement" class="tab-content">
            <h2>Gestion des Utilisateurs</h2>
            <form id="form-userManagement">
                <input type="email" id="newUserEmail" placeholder="Entrez l'email de l'utilisateur" required>
                <button type="button" onclick="ajouterUtilisateur()">Ajouter Utilisateur</button>
            </form>
            <table id="table-users">
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- CMDG (et les autres tabs similaires, je les omets pour brevité, mais ils sont identiques avec leur ID) -->
        <div id="CMDG" class="tab-content">
            <h2>CMDG - Suivi des Tâches</h2>
            <form id="form-CMDG">
                <input type="text" id="tache-CMDG" placeholder="Description de la tâche" required>
                <select id="statut-CMDG" required>
                    <option value="">Statut</option>
                    <option value="En cours">En cours</option>
                    <option value="Terminée">Terminée</option>
                    <option value="En attente">En attente</option>
                </select>
                <input type="date" id="date-CMDG" required>
                <button type="button" onclick="ajouterTache('CMDG')">Ajouter Tâche</button>
            </form>
            <table id="table-CMDG">
                <thead>
                    <tr>
                        <th>Tâche</th>
                        <th>Statut</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <button onclick="exporterDonnees('CMDG')">Exporter en CSV</button>
            <button type="button" onclick="effacerDonnees('CMDG')">Effacer Toutes les Données</button>
        </div>

        <!-- Ajoute ici les autres div pour CMDN, CMDLT, CMDB, Manhattan, Residence, completed-tasks, reports (comme dans ton code original) -->

    </main>
    
    <footer>
        <p>Application créée par Grok 4 - xAI. Données synchronisées via Firebase.</p>
    </footer>
    
    <script>
        // Remplace par ta config Firebase réelle
        const firebaseConfig = {
            // Ta config ici...
        };

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        const adminEmail = "mkhalife@cmd.cd";
        let currentUser = null;

        // Fonctions d'auth
        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            auth.signInWithEmailAndPassword(email, password)
                .then(user => {
                    currentUser = user;
                    document.getElementById('login').style.display = 'none';
                    openTab('dashboard');
                    chargerTousDonnees();
                    document.getElementById('login-message').textContent = 'Connecté !';
                })
                .catch(err => document.getElementById('login-message').textContent = 'Erreur: ' + err.message);
        }

        function register() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            auth.createUserWithEmailAndPassword(email, password)
                .then(user => document.getElementById('login-message').textContent = 'Inscrit ! Connecte-toi maintenant.')
                .catch(err => document.getElementById('login-message').textContent = 'Erreur: ' + err.message);
        }

        function logout() {
            auth.signOut().then(() => {
                currentUser = null;
                openTab('login');
            });
        }

        // Vérifie si l'utilisateur est admin
        function isAdmin() {
            return currentUser && currentUser.email === adminEmail;
        }

        // Vérifie si l'utilisateur est autorisé (basé sur Firebase, on peut ajouter une liste d'utilisateurs dans DB)
        function isAuthorized() {
            return !!currentUser;
        }

        function openTab(tabId) {
            if (!isAuthorized() && tabId !== 'login') return openTab('login');
            var tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if (tabId !== 'login') chargerDonnees(tabId);
            updateDashboard();
        }

        // Fonction pour ajouter utilisateur (seul admin)
        function ajouterUtilisateur() {
            if (!isAdmin()) return alert('Seul l\'admin peut ajouter des utilisateurs.');
            const newUserEmail = document.getElementById('newUserEmail').value;
            if (!newUserEmail) return;
            db.ref('authorizedUsers').push(newUserEmail);
            alert('Utilisateur ajouté: ' + newUserEmail);
            updateUsersTable();
        }

        // Mise à jour table utilisateurs desde Firebase
        function updateUsersTable() {
            db.ref('authorizedUsers').once('value', snapshot => {
                const tableBody = document.querySelector('#table-users tbody');
                tableBody.innerHTML = '';
                snapshot.forEach(child => {
                    const user = child.val();
                    const row = tableBody.insertRow();
                    row.insertCell(0).textContent = user;
                    const actionsCell = row.insertCell(1);
                    const removeBtn = document.createElement('button');
                    removeBtn.textContent = 'Supprimer';
                    removeBtn.onclick = () => db.ref('authorizedUsers/' + child.key).remove();
                    actionsCell.appendChild(removeBtn);
                });
            });
        }

        function ajouterTache(siteId) {
            if (!isAuthorized()) return alert('Connectez-vous pour ajouter des tâches.');
            var tache = document.getElementById(`tache-${siteId}`).value;
            var statut = document.getElementById(`statut-${siteId}`).value;
            var date = document.getElementById(`date-${siteId}`).value;

            if (!tache || !statut || !date) return alert('Veuillez remplir tous les champs.');

            // Ajoute à Firebase (sync en temps réel)
            db.ref(`tasks/${siteId}`).push({ tache, statut, date });
            alert('Nouvelle tâche ajoutée: ' + tache);
            document.getElementById(`form-${siteId}`).reset();
            updateDashboard();
        }

        function supprimerTache(siteId, key) {
            if (!isAuthorized()) return alert('Vous n\'avez pas l\'autorisation.');
            db.ref(`tasks/${siteId}/${key}`).remove();
            alert('Tâche supprimée');
            updateDashboard();
        }

        function chargerDonnees(siteId) {
            const tableBody = document.querySelector(`#table-${siteId} tbody`);
            tableBody.innerHTML = '';
            db.ref(`tasks/${siteId}`).on('value', snapshot => {  // Écoute en temps réel
                tableBody.innerHTML = '';
                snapshot.forEach(child => {
                    const item = child.val();
                    const row = tableBody.insertRow();
                    row.insertCell(0).textContent = item.tache;
                    row.insertCell(1).textContent = item.statut;
                    row.insertCell(2).textContent = item.date;
                    const actionsCell = row.insertCell(3);
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Supprimer';
                    deleteBtn.onclick = () => supprimerTache(siteId, child.key);
                    actionsCell.appendChild(deleteBtn);
                });
            });
        }

        function chargerTousDonnees() {
            ['CMDG', 'CMDN', 'CMDLT', 'CMDB', 'Manhattan', 'Residence'].forEach(siteId => chargerDonnees(siteId));
        }

        function exporterDonnees(siteId) {
            db.ref(`tasks/${siteId}`).once('value', snapshot => {
                let csv = 'Tâche,Statut,Date\n';
                snapshot.forEach(child => {
                    const item = child.val();
                    csv += `${item.tache},${item.statut},${item.date}\n`;
                });
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${siteId}_tasks.csv`;
                a.click();
            });
        }

        function effacerDonnees(siteId) {
            if (!isAdmin()) return alert('Seul l\'admin peut effacer.');
            if (confirm('Êtes-vous sûr ?')) db.ref(`tasks/${siteId}`).remove();
        }

        function updateDashboard() {
            let enCours = 0, terminees = 0, enAttente = 0;
            // Compte depuis Firebase (exemple pour tous sites, adapte si besoin)
            db.ref('tasks').once('value', snapshot => {
                snapshot.forEach(site => {
                    site.forEach(task => {
                        const statut = task.val().statut;
                        if (statut === 'En cours') enCours++;
                        else if (statut === 'Terminée') terminees++;
                        else if (statut === 'En attente') enAttente++;
                    });
                });
                document.getElementById('en-cours').textContent = `Tâches en Cours : ${enCours}`;
                document.getElementById('terminees').textContent = `Tâches Terminées : ${terminees}`;
                document.getElementById('en-attente').textContent = `Tâches en Attente : ${enAttente}`;
            });
        }

        // Pour les rapports (exemple basique, tu peux étendre)
        // Ajoute <div id="reports" class="tab-content"><h2>Rapports</h2><p id="reports-content"></p></div> dans main si pas là
        function generateReports() {
            db.ref('tasks').once('value', snapshot => {
                let report = 'Rapport global:\n';
                snapshot.forEach(site => {
                    report += `${site.key}: ${site.numChildren()} tâches\n`;
                });
                document.getElementById('reports-content').textContent = report;
            });
        }

        // Appel initial
        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (user) openTab('dashboard');
            else openTab('login');
        });
    </script>
</body>
</html>
